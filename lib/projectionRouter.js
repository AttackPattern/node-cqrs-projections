"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _objectWithoutProperties(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(o[r]=e[r]);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){function i(e,t){try{var r=c[e](t),i=r.value}catch(e){return void o(e)}r.done?n(i):Promise.resolve(i).then(a,u)}function a(e){i("next",e)}function u(e){i("throw",e)}var c=e.apply(t,r);a()})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _koaRouter=_interopRequireDefault(require("koa-router")),ProjectionRouter=function(e){function t(e){var r;return _classCallCheck(this,t),r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),Object.entries(e).map(function(e){var t=e[0],n=e[1];n.forEach(function(e){r.get("/".concat(t,"/").concat(e.name()),function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function r(n,o){var i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,e.get(n.query,n.$identity);case 3:return i=r.sent,Array.isArray(i)&&i.forEach(function(e){delete e._id,delete e.__v}),n.status=200,r.abrupt("return",n.body=i);case 9:return r.prev=9,r.t0=r.catch(0),console.log("Failed loading projection /".concat(t),r.t0),r.abrupt("return",o());case 13:case"end":return r.stop()}},r,this,[[0,9]])}));return function(e,t){return r.apply(this,arguments)}}()).get("/".concat(t,"/").concat(e.name(),"/:id"),function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function r(n,o){var i,a,u,c,s,f,p,l,y,b,_,d;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,i=n.$identity,a=n.params.id,"mine"!==a){r.next=17;break}if(i&&!i.isAnonymous()){r.next=7;break}return n.status=401,r.abrupt("return",n.body={error:"No authorization information supplied"});case 7:if(e.getMine){r.next=10;break}return n.status=404,r.abrupt("return",n.body={error:"No mine endpoint for ".concat(t)});case 10:return r.next=12,e.getMine(i);case 12:u=r.sent,c=Array.isArray(u)&&u.length?u[0]:u,s=c._id,f=c.__v,p=_objectWithoutProperties(c,["_id","__v"]),n.body=p,r.next=23;break;case 17:return r.next=19,e.getById(a,n.$identity);case 19:l=r.sent,y=Array.isArray(l)&&l.length?l[0]:l,b=y._id,_=y.__v,d=_objectWithoutProperties(y,["_id","__v"]),n.body=d,n.status=200;case 23:r.next=29;break;case 25:return r.prev=25,r.t0=r.catch(0),console.log("Failed loading projection /".concat(t),r.t0),r.abrupt("return",o());case 29:case"end":return r.stop()}},r,this,[[0,25]])}));return function(e,t){return r.apply(this,arguments)}}())})}),r}return _inherits(t,e),t}(_koaRouter.default);exports.default=ProjectionRouter;
//# sourceMappingURL=maps/projectionRouter.js.map
