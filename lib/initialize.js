"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){function i(e,t){try{var r=c[e](t),i=r.value}catch(e){return void o(e)}r.done?n(i):Promise.resolve(i).then(u,a)}function u(e){i("next",e)}function a(e){i("throw",e)}var c=e.apply(t,r);u()})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _authTokenMapper=_interopRequireDefault(require("./authTokenMapper")),_identityMiddleware=_interopRequireDefault(require("./identityMiddleware")),_projectionRouter=_interopRequireDefault(require("./projectionRouter")),_testRouter=_interopRequireDefault(require("./testRouter")),_sqlProjectionState=_interopRequireDefault(require("./sqlProjectionState")),_sqlEventFeed=_interopRequireDefault(require("./sqlEventFeed")),_projectionStore=_interopRequireDefault(require("./projectionStore")),Projections=function e(){_classCallCheck(this,e)};exports.default=Projections,Object.defineProperty(Projections,"initialize",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,u,a,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.container,n=t.config,o=t.db,i=t.storeFolder,u=t.viewFolder,r.register("db",function(){return o}),a=Object.entries(i).reduce(function(e,t){var n=t[0],o=t[1];return e[n]=r.resolve(o),e},{}),c=Object.entries(u).reduce(function(e,t){var n=t[0],o=t[1];return e[n]=Object.entries(o).map(function(e){var t=e[1];return r.resolve(t,[a])}),e},{}),s=new _sqlEventFeed.default({db:o,projectionState:new _sqlProjectionState.default}),Object.values(a).filter(function(e){return e.onEvent}).forEach(function(e){return s.subscribe(function(t){return e.onEvent(t)})}),e.next=8,(0,_projectionStore.default)(n("connections").mongoUrl);case 8:return e.abrupt("return",{routers:{projection:new _projectionRouter.default(c),test:new _testRouter.default(Object.values(a),s)},middleware:{identity:new _identityMiddleware.default(new _authTokenMapper.default({secret:n.decrypt(n("authentication").secret)})).inject}});case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluaXRpYWxpemUuanMiXSwibmFtZXMiOlsiX2F1dGhUb2tlbk1hcHBlciIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX2lkZW50aXR5TWlkZGxld2FyZSIsIl9wcm9qZWN0aW9uUm91dGVyIiwiX3Rlc3RSb3V0ZXIiLCJfc3FsUHJvamVjdGlvblN0YXRlIiwiX3NxbEV2ZW50RmVlZCIsIl9wcm9qZWN0aW9uU3RvcmUiLCJQcm9qZWN0aW9ucyIsIl9jYWxsZWUiLCJfcmVmIiwiY29udGFpbmVyIiwiY29uZmlnIiwiZGIiLCJzdG9yZUZvbGRlciIsInZpZXdGb2xkZXIiLCJzdG9yZXMiLCJ2aWV3cyIsInNxbEV2ZW50RmVlZCIsInJlZ2VuZXJhdG9yUnVudGltZSIsIndyYXAiLCJfY29udGV4dCIsInByZXYiLCJuZXh0IiwicmVnaXN0ZXIiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVkdWNlIiwibmFtZSIsIlN0b3JlIiwicmVzdWx0IiwicmVzb2x2ZSIsImNsaWVudCIsIl9yZWYzIiwiY2xpZW50Vmlld3MiLCJWaWV3IiwibWFwIiwicHJvamVjdGlvblN0YXRlIiwidmFsdWVzIiwic3RvcmUiLCJvbkV2ZW50IiwiZm9yRWFjaCIsInAiLCJzdWJzY3JpYmUiLCJlIiwiZGVmYXVsdCIsImFicnVwdCIsInJvdXRlcnMiLCJwcm9qZWN0aW9uIiwidGVzdCIsIm1pZGRsZXdhcmUiLCJpZGVudGl0eSIsInNlY3JldCIsImRlY3J5cHQiLCJpbmplY3QiLCJzdG9wIiwidGhpcyJdLCJtYXBwaW5ncyI6Im9qQkFBQSxJQUFBQSxrQkFBQUMsdUJBQUFDLFFBQUEsc0JBQ0FDLG9CQUFBRix1QkFBQUMsUUFBQSx5QkFDQUUsa0JBQUFILHVCQUFBQyxRQUFBLHVCQUNBRyxZQUFBSix1QkFBQUMsUUFBQSxpQkFFQUksb0JBQUFMLHVCQUFBQyxRQUFBLHlCQUNBSyxjQUFBTix1QkFBQUMsUUFBQSxtQkFFQU0saUJBQUFQLHVCQUFBQyxRQUFBLHNCQUVxQk8sb0dBQUFBLHFJQUNDLFFBQUFDLEdBQUFDLEdBQUEsR0FBQUMsR0FBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsQ0FBQSxPQUFBQyxvQkFBQUMsS0FBQSxTQUFBQyxHQUFBLE9BQUEsT0FBQUEsRUFBQUMsS0FBQUQsRUFBQUUsTUFBQSxJQUFBLEdBQUEsTUFBQVosR0FBQUQsRUFBQUMsVUFBQUMsRUFBQUYsRUFBQUUsT0FBQUMsRUFBQUgsRUFBQUcsR0FBQUMsRUFBQUosRUFBQUksWUFBQUMsRUFBQUwsRUFBQUssV0FDbEJKLEVBQUFBLFNBQUFBLEtBQVVhLFdBQUFBLE1BQVNYLEtBRWJHLEVBQUFBLE9BQVNTLFFBQU9DLEdBQ25CQyxPQUFBQSxTQUFBQSxFQUFBQSxHQUF1QkMsR0FBaEJBLEdBQWdCQSxFQUFoQixHQUFBQyxFQUFnQkQsRUFBaEIsRUFFTixPQURBRSxHQUFBQSxHQUFPRixFQUFRakIsUUFBVW9CLEdBQ3pCRCxPQUdFYixFQUFBQSxPQUFRUSxRQUFPQyxHQUNsQkMsT0FBQUEsU0FBQUEsRUFBQUEsR0FBc0QsR0FBL0NLLEdBQStDQyxFQUEvQyxHQUFBQyxFQUErQ0QsRUFBL0MsRUFFTixPQURBSCxHQUFBQSxHQUFPRSxPQUFQTixRQUF3QkEsR0FBUVEsSUFBQUEsU0FBQUEsR0FBQUEsR0FBaUJDLEdBQWpCRCxFQUFhRSxFQUFiRixPQUFpQnZCLEdBQUFvQixRQUFBSSxHQUFBbkIsTUFDakRjLE9BR0VaLEVBQUFBLEdBQUFBLGVBQUFBLFNBQ0pMLEdBQUFBLEVBQ0F3QixnQkFBQUEsR0FBQUEscUJBQUFBLFVBRUZaLE9BQUFBLE9BQUFBLEdBQU9hLE9BQU90QixTQUFBQSxHQUFBQSxNQUFkdUIsR0FBNkJDLFVBQUFDLFFBQUEsU0FBQUMsR0FBQSxNQUFTSCxHQUF0Q0ksVUFBNkQsU0FBQUMsR0FBQSxNQUFBRixHQUFBRixRQUFBSSxPQW5CM0N2QixFQUFBRSxLQUFBLEdBcUJaLEVBQUFoQixpQkFBQXNDLFNBQUFqQyxFQUFBLGVBQWdCQSxTQXJCSixLQUFBLEdBQUEsTUFBQVMsR0FBQXlCLE9BQUEsVUF3QmhCQyxTQUNFQyxXQUFBQSxHQUFBQSxtQkFBQUEsUUFBWS9CLEdBQ1pnQyxLQUFBQSxHQUFBQSxhQUFBQSxRQUFNeEIsT0FBQWEsT0FBQXRCLEdBQWVTLElBRXZCeUIsWUFDRUMsU0FBQUEsR0FBQUEscUJBQUFBLFFBQVUsR0FBQXBELGtCQUFBOEMsU0FDUk8sT0FBQUEsRUFBQUEsUUFBUXhDLEVBQU95QyxrQkFBZUQsV0FDNUJFLFNBL0JVLEtBQUEsR0FBQSxJQUFBLE1BQUEsTUFBQWpDLEdBQUFrQyxTQUFBOUMsRUFBQStDIiwiZmlsZSI6ImluaXRpYWxpemUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQXV0aFRva2VuTWFwcGVyIGZyb20gJy4vYXV0aFRva2VuTWFwcGVyJztcbmltcG9ydCBJZGVudGl0eU1pZGRsZXdhcmUgZnJvbSAnLi9pZGVudGl0eU1pZGRsZXdhcmUnO1xuaW1wb3J0IFByb2plY3Rpb25Sb3V0ZXIgZnJvbSAnLi9wcm9qZWN0aW9uUm91dGVyJztcbmltcG9ydCBUZXN0Um91dGVyIGZyb20gJy4vdGVzdFJvdXRlcic7XG5cbmltcG9ydCBTcWxQcm9qZWN0aW9uU3RhdGUgZnJvbSAnLi9zcWxQcm9qZWN0aW9uU3RhdGUnO1xuaW1wb3J0IFNxbEV2ZW50RmVlZCBmcm9tICcuL3NxbEV2ZW50RmVlZCc7XG5cbmltcG9ydCBwcm9qZWN0aW9uU3RvcmUgZnJvbSAnLi9wcm9qZWN0aW9uU3RvcmUnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQcm9qZWN0aW9ucyB7XG4gIHN0YXRpYyBpbml0aWFsaXplID0gYXN5bmMgKHsgY29udGFpbmVyLCBjb25maWcsIGRiLCBzdG9yZUZvbGRlciwgdmlld0ZvbGRlciB9KSA9PiB7XG4gICAgY29udGFpbmVyLnJlZ2lzdGVyKCdkYicsICgpID0+IGRiKTtcblxuICAgIGNvbnN0IHN0b3JlcyA9IE9iamVjdC5lbnRyaWVzKHN0b3JlRm9sZGVyKVxuICAgICAgLnJlZHVjZSgocmVzdWx0LCB7IFswXTogbmFtZSwgWzFdOiBTdG9yZSB9KSA9PiB7XG4gICAgICAgIHJlc3VsdFtuYW1lXSA9IGNvbnRhaW5lci5yZXNvbHZlKFN0b3JlKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0sIHt9KTtcblxuICAgIGNvbnN0IHZpZXdzID0gT2JqZWN0LmVudHJpZXModmlld0ZvbGRlcilcbiAgICAgIC5yZWR1Y2UoKHJlc3VsdCwgeyBbMF06IGNsaWVudCwgWzFdOiBjbGllbnRWaWV3cyB9KSA9PiB7XG4gICAgICAgIHJlc3VsdFtjbGllbnRdID0gT2JqZWN0LmVudHJpZXMoY2xpZW50Vmlld3MpLm1hcCgoeyBbMV06IFZpZXcgfSkgPT4gY29udGFpbmVyLnJlc29sdmUoVmlldywgW3N0b3Jlc10pKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0sIHt9KTtcblxuICAgIGNvbnN0IHNxbEV2ZW50RmVlZCA9IG5ldyBTcWxFdmVudEZlZWQoe1xuICAgICAgZGIsXG4gICAgICBwcm9qZWN0aW9uU3RhdGU6IG5ldyBTcWxQcm9qZWN0aW9uU3RhdGUoKVxuICAgIH0pO1xuICAgIE9iamVjdC52YWx1ZXMoc3RvcmVzKS5maWx0ZXIoc3RvcmUgPT4gc3RvcmUub25FdmVudCkuZm9yRWFjaChwID0+IHNxbEV2ZW50RmVlZC5zdWJzY3JpYmUoZSA9PiBwLm9uRXZlbnQoZSkpKTtcblxuICAgIGF3YWl0IHByb2plY3Rpb25TdG9yZShjb25maWcoJ2Nvbm5lY3Rpb25zJykubW9uZ29VcmwpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJvdXRlcnM6IHtcbiAgICAgICAgcHJvamVjdGlvbjogbmV3IFByb2plY3Rpb25Sb3V0ZXIodmlld3MpLFxuICAgICAgICB0ZXN0OiBuZXcgVGVzdFJvdXRlcihPYmplY3QudmFsdWVzKHN0b3JlcyksIHNxbEV2ZW50RmVlZClcbiAgICAgIH0sXG4gICAgICBtaWRkbGV3YXJlOiB7XG4gICAgICAgIGlkZW50aXR5OiBuZXcgSWRlbnRpdHlNaWRkbGV3YXJlKG5ldyBBdXRoVG9rZW5NYXBwZXIoe1xuICAgICAgICAgIHNlY3JldDogY29uZmlnLmRlY3J5cHQoY29uZmlnKCdhdXRoZW50aWNhdGlvbicpLnNlY3JldClcbiAgICAgICAgfSkpLmluamVjdFxuICAgICAgfVxuICAgIH07XG4gIH1cbn1cbiJdfQ==
