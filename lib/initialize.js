"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,t,r,n,o,i,u){try{var a=e[i](u),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,o)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){function i(e){asyncGeneratorStep(a,n,o,i,u,"next",e)}function u(e){asyncGeneratorStep(a,n,o,i,u,"throw",e)}var a=e.apply(t,r);i(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _authTokenMapper=_interopRequireDefault(require("./authTokenMapper")),_identityMiddleware=_interopRequireDefault(require("./identityMiddleware")),_projectionRouter=_interopRequireDefault(require("./projectionRouter")),_testRouter=_interopRequireDefault(require("./testRouter")),_sqlProjectionState=_interopRequireDefault(require("./sqlProjectionState")),_sqlEventFeed=_interopRequireDefault(require("./sqlEventFeed")),_projectionStore=_interopRequireDefault(require("./projectionStore")),Projections=function e(){_classCallCheck(this,e)};exports.default=Projections,_defineProperty(Projections,"initialize",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,u,a,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.container,n=t.config,o=t.db,i=t.storeFolder,u=t.viewFolder,r.register("db",function(){return o}),a=Object.entries(i).reduce(function(e,t){var n=t[0],o=t[1];return e[n]=r.resolve(o),e},{}),c=Object.entries(u).reduce(function(e,t){var n=t[0],o=t[1];return e[n]=Object.entries(o).map(function(e){var t=e[0],n=e[1];return{name:t,view:r.resolve(n,[a])}}),e},{}),s=new _sqlEventFeed.default({db:o,projectionState:new _sqlProjectionState.default}),Object.values(a).filter(function(e){return e.onEvent}).forEach(function(e){return s.subscribe(function(t){return e.onEvent(t)})}),e.next=8,(0,_projectionStore.default)(n("connections").mongoUrl);case 8:return e.abrupt("return",{routers:{projection:new _projectionRouter.default(c),test:new _testRouter.default(Object.values(a),s)},middleware:{identity:new _identityMiddleware.default(new _authTokenMapper.default({secret:n.decrypt(n("authentication").secret)})).inject}});case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}());
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluaXRpYWxpemUuanMiXSwibmFtZXMiOlsiX2F1dGhUb2tlbk1hcHBlciIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX2lkZW50aXR5TWlkZGxld2FyZSIsIl9wcm9qZWN0aW9uUm91dGVyIiwiX3Rlc3RSb3V0ZXIiLCJfc3FsUHJvamVjdGlvblN0YXRlIiwiX3NxbEV2ZW50RmVlZCIsIl9wcm9qZWN0aW9uU3RvcmUiLCJQcm9qZWN0aW9ucyIsIl9jYWxsZWUiLCJfcmVmIiwiY29udGFpbmVyIiwiY29uZmlnIiwiZGIiLCJzdG9yZUZvbGRlciIsInZpZXdGb2xkZXIiLCJzdG9yZXMiLCJ2aWV3cyIsInNxbEV2ZW50RmVlZCIsInJlZ2VuZXJhdG9yUnVudGltZSIsIndyYXAiLCJfY29udGV4dCIsInByZXYiLCJuZXh0IiwicmVnaXN0ZXIiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVkdWNlIiwicmVzdWx0IiwiX3JlZjMiLCJuYW1lIiwiU3RvcmUiLCJyZXNvbHZlIiwiX3JlZjQiLCJjbGllbnQiLCJjbGllbnRWaWV3cyIsIm1hcCIsIl9yZWY1IiwiVmlldyIsInZpZXciLCJTcWxFdmVudEZlZWQiLCJwcm9qZWN0aW9uU3RhdGUiLCJTcWxQcm9qZWN0aW9uU3RhdGUiLCJ2YWx1ZXMiLCJmaWx0ZXIiLCJzdG9yZSIsIm9uRXZlbnQiLCJmb3JFYWNoIiwicCIsInN1YnNjcmliZSIsImUiLCJkZWZhdWx0IiwibW9uZ29VcmwiLCJhYnJ1cHQiLCJyb3V0ZXJzIiwicHJvamVjdGlvbiIsIlByb2plY3Rpb25Sb3V0ZXIiLCJ0ZXN0IiwibWlkZGxld2FyZSIsImlkZW50aXR5IiwiSWRlbnRpdHlNaWRkbGV3YXJlIiwiQXV0aFRva2VuTWFwcGVyIiwic2VjcmV0IiwiZGVjcnlwdCIsImluamVjdCIsInN0b3AiLCJ0aGlzIl0sIm1hcHBpbmdzIjoiaXhCQUFBLElBQUFBLGtCQUFBQyx1QkFBQUMsUUFBQSxzQkFDQUMsb0JBQUFGLHVCQUFBQyxRQUFBLHlCQUNBRSxrQkFBQUgsdUJBQUFDLFFBQUEsdUJBQ0FHLFlBQUFKLHVCQUFBQyxRQUFBLGlCQUVBSSxvQkFBQUwsdUJBQUFDLFFBQUEseUJBQ0FLLGNBQUFOLHVCQUFBQyxRQUFBLG1CQUVBTSxpQkFBQVAsdUJBQUFDLFFBQUEsc0JBRXFCTyw4RkFBQUEsb0ZBUnJCLFFBQUFDLEdBQUFDLEdBQUEsR0FBQUMsR0FBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsQ0FBQSxPQUFBQyxvQkFBQUMsS0FBQSxTQUFBQyxHQUFBLE9BQUEsT0FBQUEsRUFBQUMsS0FBQUQsRUFBQUUsTUFBQSxJQUFBLEdBQUEsTUFBQVosR0FBQUQsRUFBQUMsVUFBQUMsRUFBQUYsRUFBQUUsT0FBQUMsRUFBQUgsRUFBQUcsR0FBQUMsRUFBQUosRUFBQUksWUFBQUMsRUFBQUwsRUFBQUssV0FVSUosRUFBVWEsU0FBUyxLQUFNLFdBQUEsTUFBTVgsS0FFekJHLEVBQVNTLE9BQU9DLFFBQVFaLEdBVGxDYSxPQUFBLFNBQUFDLEVBQUFDLEdBQUEsR0FBQUMsR0FBQUQsRUFBQSxHQUFBRSxFQUFBRixFQUFBLEVBQ0EsT0FVUUQsR0FBT0UsR0FBUW5CLEVBQVVxQixRQUFRRCxHQVZ6Q0gsT0FjVVgsRUFBUVEsT0FBT0MsUUFBUVgsR0FDMUJZLE9BQU8sU0FBQ0MsRUFBREssR0FBK0MsR0FBL0JDLEdBQStCRCxFQUFuQyxHQUFpQkUsRUFBa0JGLEVBQXRCLEVBRS9CLE9BREFMLEdBQU9NLEdBQVVULE9BQU9DLFFBQVFTLEdBQWFDLElBQUksU0FBQUMsR0FBQSxHQUFRUCxHQUFSTyxFQUFJLEdBQWVDLEVBQW5CRCxFQUFlLEVBQWYsUUFBaUNQLEtBQUFBLEVBQU1TLEtBQU01QixFQUFVcUIsUUFBUU0sR0FBT3RCLE9BQ2hIWSxPQUdMVixFQUFlLEdBQUlzQixlQUFBQSxTQUN2QjNCLEdBQUFBLEVBQ0E0QixnQkFBaUIsR0FBSUMscUJBQUFBLFVBRXZCakIsT0FBT2tCLE9BQU8zQixHQUFRNEIsT0FBTyxTQUFBQyxHQUFLLE1BQUlBLEdBQU1DLFVBQVNDLFFBQVEsU0FBQUMsR0FBQyxNQUFJOUIsR0FBYStCLFVBQVUsU0FBQUMsR0FBQyxNQUFJRixHQUFFRixRQUFRSSxPQTVCNUc3QixFQUFBRSxLQUFBLEdBOEJVLEVBQUFoQixpQkFBQTRDLFNBQWdCdkMsRUFBTyxlQUFld0MsU0E5QmhELEtBQUEsR0FBQSxNQUFBL0IsR0FBQWdDLE9BQUEsVUFpQ01DLFNBQ0VDLFdBQVksR0FBSUMsbUJBQUFBLFFBQWlCdkMsR0FDakN3QyxLQUFNLEdBM0JPakQsYUFBQUEsUUEyQlFpQixPQUFPa0IsT0FBTzNCLEdBQVNFLElBRTlDd0MsWUFDRUMsU0FBVSxHQUFJQyxxQkFBQUEsUUFBbUIsR0FBSUMsa0JBQUFBLFNBQ25DQyxPQUFRbEQsRUFBT21ELFFBQVFuRCxFQUFPLGtCQUFrQmtELFdBQzlDRSxTQXhDWixLQUFBLEdBQUEsSUFBQSxNQUFBLE1BQUEzQyxHQUFBNEMsU0FBQXhELEVBQUF5RCIsImZpbGUiOiJpbml0aWFsaXplLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEF1dGhUb2tlbk1hcHBlciBmcm9tICcuL2F1dGhUb2tlbk1hcHBlcic7XG5pbXBvcnQgSWRlbnRpdHlNaWRkbGV3YXJlIGZyb20gJy4vaWRlbnRpdHlNaWRkbGV3YXJlJztcbmltcG9ydCBQcm9qZWN0aW9uUm91dGVyIGZyb20gJy4vcHJvamVjdGlvblJvdXRlcic7XG5pbXBvcnQgVGVzdFJvdXRlciBmcm9tICcuL3Rlc3RSb3V0ZXInO1xuXG5pbXBvcnQgU3FsUHJvamVjdGlvblN0YXRlIGZyb20gJy4vc3FsUHJvamVjdGlvblN0YXRlJztcbmltcG9ydCBTcWxFdmVudEZlZWQgZnJvbSAnLi9zcWxFdmVudEZlZWQnO1xuXG5pbXBvcnQgcHJvamVjdGlvblN0b3JlIGZyb20gJy4vcHJvamVjdGlvblN0b3JlJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUHJvamVjdGlvbnMge1xuICBzdGF0aWMgaW5pdGlhbGl6ZSA9IGFzeW5jICh7IGNvbnRhaW5lciwgY29uZmlnLCBkYiwgc3RvcmVGb2xkZXIsIHZpZXdGb2xkZXIgfSkgPT4ge1xuICAgIGNvbnRhaW5lci5yZWdpc3RlcignZGInLCAoKSA9PiBkYik7XG5cbiAgICBjb25zdCBzdG9yZXMgPSBPYmplY3QuZW50cmllcyhzdG9yZUZvbGRlcilcbiAgICAgIC5yZWR1Y2UoKHJlc3VsdCwgeyBbMF06IG5hbWUsIFsxXTogU3RvcmUgfSkgPT4ge1xuICAgICAgICByZXN1bHRbbmFtZV0gPSBjb250YWluZXIucmVzb2x2ZShTdG9yZSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9LCB7fSk7XG5cbiAgICBjb25zdCB2aWV3cyA9IE9iamVjdC5lbnRyaWVzKHZpZXdGb2xkZXIpXG4gICAgICAucmVkdWNlKChyZXN1bHQsIHsgWzBdOiBjbGllbnQsIFsxXTogY2xpZW50Vmlld3MgfSkgPT4ge1xuICAgICAgICByZXN1bHRbY2xpZW50XSA9IE9iamVjdC5lbnRyaWVzKGNsaWVudFZpZXdzKS5tYXAoKHsgWzBdOiBuYW1lLCBbMV06IFZpZXcgfSkgPT4gKHsgbmFtZSwgdmlldzogY29udGFpbmVyLnJlc29sdmUoVmlldywgW3N0b3Jlc10pIH0pKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0sIHt9KTtcblxuICAgIGNvbnN0IHNxbEV2ZW50RmVlZCA9IG5ldyBTcWxFdmVudEZlZWQoe1xuICAgICAgZGIsXG4gICAgICBwcm9qZWN0aW9uU3RhdGU6IG5ldyBTcWxQcm9qZWN0aW9uU3RhdGUoKVxuICAgIH0pO1xuICAgIE9iamVjdC52YWx1ZXMoc3RvcmVzKS5maWx0ZXIoc3RvcmUgPT4gc3RvcmUub25FdmVudCkuZm9yRWFjaChwID0+IHNxbEV2ZW50RmVlZC5zdWJzY3JpYmUoZSA9PiBwLm9uRXZlbnQoZSkpKTtcblxuICAgIGF3YWl0IHByb2plY3Rpb25TdG9yZShjb25maWcoJ2Nvbm5lY3Rpb25zJykubW9uZ29VcmwpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJvdXRlcnM6IHtcbiAgICAgICAgcHJvamVjdGlvbjogbmV3IFByb2plY3Rpb25Sb3V0ZXIodmlld3MpLFxuICAgICAgICB0ZXN0OiBuZXcgVGVzdFJvdXRlcihPYmplY3QudmFsdWVzKHN0b3JlcyksIHNxbEV2ZW50RmVlZClcbiAgICAgIH0sXG4gICAgICBtaWRkbGV3YXJlOiB7XG4gICAgICAgIGlkZW50aXR5OiBuZXcgSWRlbnRpdHlNaWRkbGV3YXJlKG5ldyBBdXRoVG9rZW5NYXBwZXIoe1xuICAgICAgICAgIHNlY3JldDogY29uZmlnLmRlY3J5cHQoY29uZmlnKCdhdXRoZW50aWNhdGlvbicpLnNlY3JldClcbiAgICAgICAgfSkpLmluamVjdFxuICAgICAgfVxuICAgIH07XG4gIH1cbn1cbiJdfQ==
