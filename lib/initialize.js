"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){function i(e,t){try{var r=c[e](t),i=r.value}catch(e){return void o(e)}r.done?n(i):Promise.resolve(i).then(u,a)}function u(e){i("next",e)}function a(e){i("throw",e)}var c=e.apply(t,r);u()})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _authTokenMapper=_interopRequireDefault(require("./authTokenMapper")),_identityMiddleware=_interopRequireDefault(require("./identityMiddleware")),_projectionRouter=_interopRequireDefault(require("./projectionRouter")),_testRouter=_interopRequireDefault(require("./testRouter")),_sqlProjectionState=_interopRequireDefault(require("./sqlProjectionState")),_sqlEventFeed=_interopRequireDefault(require("./sqlEventFeed")),_projectionStore=_interopRequireDefault(require("./projectionStore")),Projections=function e(){_classCallCheck(this,e)};exports.default=Projections,_defineProperty(Projections,"initialize",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i,u,a,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.container,n=t.config,o=t.db,i=t.storeFolder,u=t.viewFolder,r.register("db",function(){return o}),a=Object.entries(i).reduce(function(e,t){var n=t[0],o=t[1];return e[n]=r.resolve(o),e},{}),c=Object.entries(u).reduce(function(e,t){var n=t[0],o=t[1];return e[n]=Object.entries(o).map(function(e){var t=e[0],n=e[1];return{name:t,view:r.resolve(n,[a])}}),e},{}),s=new _sqlEventFeed.default({db:o,projectionState:new _sqlProjectionState.default}),Object.values(a).filter(function(e){return e.onEvent}).forEach(function(e){return s.subscribe(function(t){return e.onEvent(t)})}),e.next=8,(0,_projectionStore.default)(n("connections").mongoUrl);case 8:return e.abrupt("return",{routers:{projection:new _projectionRouter.default(c),test:new _testRouter.default(Object.values(a),s)},middleware:{identity:new _identityMiddleware.default(new _authTokenMapper.default({secret:n.decrypt(n("authentication").secret)})).inject}});case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}());
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluaXRpYWxpemUuanMiXSwibmFtZXMiOlsiX2F1dGhUb2tlbk1hcHBlciIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX2lkZW50aXR5TWlkZGxld2FyZSIsIl9wcm9qZWN0aW9uUm91dGVyIiwiX3Rlc3RSb3V0ZXIiLCJfc3FsUHJvamVjdGlvblN0YXRlIiwiX3NxbEV2ZW50RmVlZCIsIl9wcm9qZWN0aW9uU3RvcmUiLCJQcm9qZWN0aW9ucyIsIl9jYWxsZWUiLCJfcmVmIiwiY29udGFpbmVyIiwiY29uZmlnIiwiZGIiLCJzdG9yZUZvbGRlciIsInZpZXdGb2xkZXIiLCJzdG9yZXMiLCJ2aWV3cyIsInNxbEV2ZW50RmVlZCIsInJlZ2VuZXJhdG9yUnVudGltZSIsIndyYXAiLCJfY29udGV4dCIsInByZXYiLCJuZXh0IiwicmVnaXN0ZXIiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVkdWNlIiwicmVzdWx0IiwiX3JlZjMiLCJTdG9yZSIsIm5hbWUiLCJyZXNvbHZlIiwiX3JlZjQiLCJjbGllbnRWaWV3cyIsImNsaWVudCIsIl9yZWY1IiwibWFwIiwiVmlldyIsInZpZXciLCJTcWxFdmVudEZlZWQiLCJwcm9qZWN0aW9uU3RhdGUiLCJzdG9yZSIsIm9uRXZlbnQiLCJmb3JFYWNoIiwicCIsImUiLCJkZWZhdWx0IiwiYWJydXB0Iiwicm91dGVycyIsInByb2plY3Rpb24iLCJQcm9qZWN0aW9uUm91dGVyIiwidGVzdCIsIlRlc3RSb3V0ZXIiLCJtaWRkbGV3YXJlIiwiaWRlbnRpdHkiLCJJZGVudGl0eU1pZGRsZXdhcmUiLCJzZWNyZXQiLCJkZWNyeXB0IiwiaW5qZWN0Iiwic3RvcCIsInRoaXMiXSwibWFwcGluZ3MiOiIwckJBQUEsSUFBQUEsa0JBQUFDLHVCQUFBQyxRQUFBLHNCQUNBQyxvQkFBQUYsdUJBQUFDLFFBQUEseUJBQ0FFLGtCQUFBSCx1QkFBQUMsUUFBQSx1QkFDQUcsWUFBQUosdUJBQUFDLFFBQUEsaUJBRUFJLG9CQUFBTCx1QkFBQUMsUUFBQSx5QkFDQUssY0FBQU4sdUJBQUFDLFFBQUEsbUJBRUFNLGlCQUFBUCx1QkFBQUMsUUFBQSxzQkFFcUJPLDhGQUFBQSxvRkFDQyxRQUFBQyxHQUFBQyxHQUFBLEdBQUFDLEdBQUFDLEVBQUFDLEVBQUFDLEVBQUFDLEVBQUFDLEVBQUFDLEVBQUFDLENBQUEsT0FBQUMsb0JBQUFDLEtBQUEsU0FBQUMsR0FBQSxPQUFBLE9BQUFBLEVBQUFDLEtBQUFELEVBQUFFLE1BQUEsSUFBQSxHQUFBLE1BQUFaLEdBQUFELEVBQUFDLFVBQUFDLEVBQUFGLEVBQUFFLE9BQUFDLEVBQUFILEVBQUFHLEdBQUFDLEVBQUFKLEVBQUFJLFlBQUFDLEVBQUFMLEVBQUFLLFdBQ2xCSixFQUFBQSxTQUFVYSxLQUFBQSxXQUFBQSxNQUFWWCxLQUVNRyxFQUhZUyxPQUdIQSxRQUFPQyxHQUNuQkMsT0FBQUEsU0FBQUEsRUFBQUEsR0FBOEMsR0FBdENDLEdBQXNDQyxFQUF2QyxHQUFBQyxFQUF1Q0QsRUFBdkMsRUFFTixPQURBRCxHQUFBQSxHQUFPRyxFQUFRcEIsUUFBVXFCLEdBQ3pCSixPQUdFWCxFQVRZUSxPQVNKQSxRQUFPQyxHQUNsQkMsT0FBQUEsU0FBQUEsRUFBQUEsR0FBc0QsR0FBOUNDLEdBQThDSyxFQUEvQyxHQUFBQyxFQUErQ0QsRUFBL0MsRUFFTixPQURBTCxHQUFBQSxHQUFPTyxPQUFVVixRQUFPQyxHQUFRUSxJQUFmLFNBQUFFLEdBQUEsR0FBZ0NMLEdBQWhDSyxFQUE0QkMsR0FBSUMsRUFBaENGLEVBQWdDLEVBQWhDLFFBQWdDTCxLQUFBQSxFQUFBUSxLQUFtQkQsRUFBbkJOLFFBQUFNLEdBQWlDUCxPQUNsRkgsT0FHRVYsRUFmWSxHQWVHc0IsZUFBQUEsU0FDbkIzQixHQUFBQSxFQUNBNEIsZ0JBQUFBLEdBQUFBLHFCQUFBQSxVQUVGaEIsT0FBQUEsT0FBQUEsR0FBY1QsT0FBZCxTQUFBMEIsR0FBQSxNQUE2QkEsR0FBQUMsVUFBQUMsUUFBQSxTQUFBQyxHQUFBLE1BQVNILEdBQWVFLFVBQVEsU0FBQUUsR0FBQSxNQUFBRCxHQUFBRixRQUFBRyxPQW5CM0N6QixFQUFBRSxLQUFBLEdBcUJaLEVBQUFoQixpQkFBQXdDLFNBQUFuQyxFQUFBLGVBQWdCQSxTQXJCSixLQUFBLEdBQUEsTUFBQVMsR0FBQTJCLE9BQUEsVUF3QmhCQyxTQUNFQyxXQUFBQSxHQUFBQSxtQkFBQUEsUUFBZ0JDLEdBQ2hCQyxLQUFBQSxHQUFBQSxhQUFBQSxRQUFVQyxPQUFBQSxPQUFBQSxHQUFXNUIsSUFFdkI2QixZQUNFQyxTQUFBQSxHQUFBQSxxQkFBQUEsUUFBY0MsR0FBQUEsa0JBQUFBLFNBQ1pDLE9BQUFBLEVBQUFBLFFBQWVDLEVBQVAsa0JBQXNCRCxXQUM1QkUsU0EvQlUsS0FBQSxHQUFBLElBQUEsTUFBQSxNQUFBdEMsR0FBQXVDLFNBQUFuRCxFQUFBb0QiLCJmaWxlIjoiaW5pdGlhbGl6ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBdXRoVG9rZW5NYXBwZXIgZnJvbSAnLi9hdXRoVG9rZW5NYXBwZXInO1xuaW1wb3J0IElkZW50aXR5TWlkZGxld2FyZSBmcm9tICcuL2lkZW50aXR5TWlkZGxld2FyZSc7XG5pbXBvcnQgUHJvamVjdGlvblJvdXRlciBmcm9tICcuL3Byb2plY3Rpb25Sb3V0ZXInO1xuaW1wb3J0IFRlc3RSb3V0ZXIgZnJvbSAnLi90ZXN0Um91dGVyJztcblxuaW1wb3J0IFNxbFByb2plY3Rpb25TdGF0ZSBmcm9tICcuL3NxbFByb2plY3Rpb25TdGF0ZSc7XG5pbXBvcnQgU3FsRXZlbnRGZWVkIGZyb20gJy4vc3FsRXZlbnRGZWVkJztcblxuaW1wb3J0IHByb2plY3Rpb25TdG9yZSBmcm9tICcuL3Byb2plY3Rpb25TdG9yZSc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFByb2plY3Rpb25zIHtcbiAgc3RhdGljIGluaXRpYWxpemUgPSBhc3luYyAoeyBjb250YWluZXIsIGNvbmZpZywgZGIsIHN0b3JlRm9sZGVyLCB2aWV3Rm9sZGVyIH0pID0+IHtcbiAgICBjb250YWluZXIucmVnaXN0ZXIoJ2RiJywgKCkgPT4gZGIpO1xuXG4gICAgY29uc3Qgc3RvcmVzID0gT2JqZWN0LmVudHJpZXMoc3RvcmVGb2xkZXIpXG4gICAgICAucmVkdWNlKChyZXN1bHQsIHsgWzBdOiBuYW1lLCBbMV06IFN0b3JlIH0pID0+IHtcbiAgICAgICAgcmVzdWx0W25hbWVdID0gY29udGFpbmVyLnJlc29sdmUoU3RvcmUpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSwge30pO1xuXG4gICAgY29uc3Qgdmlld3MgPSBPYmplY3QuZW50cmllcyh2aWV3Rm9sZGVyKVxuICAgICAgLnJlZHVjZSgocmVzdWx0LCB7IFswXTogY2xpZW50LCBbMV06IGNsaWVudFZpZXdzIH0pID0+IHtcbiAgICAgICAgcmVzdWx0W2NsaWVudF0gPSBPYmplY3QuZW50cmllcyhjbGllbnRWaWV3cykubWFwKCh7IFswXTogbmFtZSwgWzFdOiBWaWV3IH0pID0+ICh7IG5hbWUsIHZpZXc6IGNvbnRhaW5lci5yZXNvbHZlKFZpZXcsIFtzdG9yZXNdKSB9KSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9LCB7fSk7XG5cbiAgICBjb25zdCBzcWxFdmVudEZlZWQgPSBuZXcgU3FsRXZlbnRGZWVkKHtcbiAgICAgIGRiLFxuICAgICAgcHJvamVjdGlvblN0YXRlOiBuZXcgU3FsUHJvamVjdGlvblN0YXRlKClcbiAgICB9KTtcbiAgICBPYmplY3QudmFsdWVzKHN0b3JlcykuZmlsdGVyKHN0b3JlID0+IHN0b3JlLm9uRXZlbnQpLmZvckVhY2gocCA9PiBzcWxFdmVudEZlZWQuc3Vic2NyaWJlKGUgPT4gcC5vbkV2ZW50KGUpKSk7XG5cbiAgICBhd2FpdCBwcm9qZWN0aW9uU3RvcmUoY29uZmlnKCdjb25uZWN0aW9ucycpLm1vbmdvVXJsKTtcblxuICAgIHJldHVybiB7XG4gICAgICByb3V0ZXJzOiB7XG4gICAgICAgIHByb2plY3Rpb246IG5ldyBQcm9qZWN0aW9uUm91dGVyKHZpZXdzKSxcbiAgICAgICAgdGVzdDogbmV3IFRlc3RSb3V0ZXIoT2JqZWN0LnZhbHVlcyhzdG9yZXMpLCBzcWxFdmVudEZlZWQpXG4gICAgICB9LFxuICAgICAgbWlkZGxld2FyZToge1xuICAgICAgICBpZGVudGl0eTogbmV3IElkZW50aXR5TWlkZGxld2FyZShuZXcgQXV0aFRva2VuTWFwcGVyKHtcbiAgICAgICAgICBzZWNyZXQ6IGNvbmZpZy5kZWNyeXB0KGNvbmZpZygnYXV0aGVudGljYXRpb24nKS5zZWNyZXQpXG4gICAgICAgIH0pKS5pbmplY3RcbiAgICAgIH1cbiAgICB9O1xuICB9XG59XG4iXX0=
