"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _async=require("async"),_bookshelf=_interopRequireDefault(require("bookshelf"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,t,r,n,a,o,u){try{var c=e[o](u),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(c){return function(){var e=this,u=arguments;return new Promise(function(t,r){var n=c.apply(e,u);function a(e){asyncGeneratorStep(n,t,r,a,o,"next",e)}function o(e){asyncGeneratorStep(n,t,r,a,o,"throw",e)}a(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(e){_defineProperty(t,e,r[e])})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var pollingInterval=100,eventBatchSize=10;function fromStoredEvent(e){return _objectSpread({aggregate:e.aggregate,aggregateId:e.aggregateId,timestamp:e.timestamp,type:e.type,sequenceNumber:e.sequenceNumber,actor:e.actor,position:JSON.parse(e.position)},JSON.parse(e.body))}var EventStore=function(){function a(e){var i=this,t=e.db,r=e.projectionState,n=e.activeState;_classCallCheck(this,a),_defineProperty(this,"consumeEventStream",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.projectionState.bookmark();case 2:return t=e.sent,e.next=5,i.getNextEvents(t);case 5:if(r=e.sent,n=r.events,a=r.bookmark,o=r.lastBookmark,n.length)return n.forEach(function(e){i.queue.push(e)}),e.next=13,i.projectionState.setBookmark(a);e.next=13;break;case 13:setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.consumeEventStream();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)})),a<o?0:pollingInterval);case 14:case"end":return e.stop()}},e)}))),_defineProperty(this,"getNextEvents",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,o,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.Event.where("id",">",t).query(function(e){return e.orderBy("id","asc")}).fetchPage({pageSize:eventBatchSize});case 3:return r=e.sent.toJSON(),n=t,r.length&&(a=r.length,o=r[a-1],n=o.id),e.next=8,i.Event.query(function(e){return e.orderBy("id","desc")}).fetchPage({pageSize:1});case 8:return u=e.sent.toJSON()[0],c=u&&u.id,e.abrupt("return",{events:r.map(function(e){return fromStoredEvent(e)}),bookmark:n,lastBookmark:c});case 13:return e.prev=13,e.t0=e.catch(0),"ER_BAD_DB_ERROR"!==e.t0.code&&console.log("Error loading events",e.t0),e.abrupt("return",{events:[],bookmark:t});case 17:case"end":return e.stop()}},e,null,[[0,13]])}));return function(e){return t.apply(this,arguments)}}()),_defineProperty(this,"reset",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.projectionState.reset(t);case 2:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),this.subscriptions=[],this.projectionState=r,this.activeState=n,this.queue=(0,_async.queue)(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Event: ".concat(r.aggregateId," ").concat(r.aggregate,".").concat(r.type)),e.next=3,Promise.all(i.subscriptions.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t(r);case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),global.log?global.log.note({error:e.t0,aggregateId:r.aggregateId,aggregate:r.aggregate,type:r.type,event:r}):console.log(e.t0);case 9:case"end":return e.stop()}},e,null,[[0,6]])}));return function(e){return t.apply(this,arguments)}}()));case 3:if("resetting"===i.activeState.state&&0===i.queue.length())return e.next=6,i.activeState.swap;e.next=9;break;case 6:if(e.t0=e.sent,!e.t0){e.next=9;break}i.activeState.swap();case 9:return e.abrupt("return",t());case 10:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}()),this.Event=(0,_bookshelf.default)(t.knex("eventstore")).plugin("pagination").Model.extend({tableName:"events"}),this.consumeEventStream()}return _createClass(a,[{key:"subscribe",value:function(e){this.subscriptions.push(e)}}]),a}();exports.default=EventStore;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNxbEV2ZW50RmVlZC5qcyJdLCJuYW1lcyI6WyJfYXN5bmMiLCJyZXF1aXJlIiwiX2Jvb2tzaGVsZiIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJwb2xsaW5nSW50ZXJ2YWwiLCJldmVudEJhdGNoU2l6ZSIsImZyb21TdG9yZWRFdmVudCIsImV2ZW50IiwiX29iamVjdFNwcmVhZCIsImFnZ3JlZ2F0ZSIsImFnZ3JlZ2F0ZUlkIiwidGltZXN0YW1wIiwidHlwZSIsInNlcXVlbmNlTnVtYmVyIiwiYWN0b3IiLCJwb3NpdGlvbiIsIkpTT04iLCJwYXJzZSIsImJvZHkiLCJFdmVudFN0b3JlIiwiX3JlZiIsIl90aGlzIiwidGhpcyIsImRiIiwicHJvamVjdGlvblN0YXRlIiwiYWN0aXZlU3RhdGUiLCJfY2xhc3NDYWxsQ2hlY2siLCJfZGVmaW5lUHJvcGVydHkiLCJfYXN5bmNUb0dlbmVyYXRvciIsInJlZ2VuZXJhdG9yUnVudGltZSIsIm1hcmsiLCJfY2FsbGVlMiIsImJvb2ttYXJrIiwiX3JlZjMiLCJldmVudHMiLCJuZXdCb29rbWFyayIsImxhc3RCb29rbWFyayIsIndyYXAiLCJfY29udGV4dDIiLCJwcmV2IiwibmV4dCIsInNlbnQiLCJnZXROZXh0RXZlbnRzIiwibGVuZ3RoIiwiZm9yRWFjaCIsInF1ZXVlIiwicHVzaCIsInNldEJvb2ttYXJrIiwic2V0VGltZW91dCIsIl9jYWxsZWUiLCJfY29udGV4dCIsImFicnVwdCIsInN0b3AiLCJfcmVmNSIsIl9jYWxsZWUzIiwibCIsImxhc3RFdmVudCIsImxhc3RSZWNvcmQiLCJfY29udGV4dDMiLCJFdmVudCIsInF1ZXJ5IiwicWIiLCJvcmRlckJ5IiwiZmV0Y2hQYWdlIiwidG9KU09OIiwiaWQiLCJwYWdlU2l6ZSIsIm1hcCIsImUiLCJ0MCIsImNvZGUiLCJjb25zb2xlIiwibG9nIiwiX3giLCJhcHBseSIsImFyZ3VtZW50cyIsIl9yZWY2IiwiX2NhbGxlZTQiLCJfY29udGV4dDQiLCJyZXNldCIsIl94MiIsInN1YnNjcmlwdGlvbnMiLCJfcmVmNyIsIl9jYWxsZWU2IiwiY2FsbGJhY2siLCJfY29udGV4dDYiLCJjb25jYXQiLCJhbGwiLCJfcmVmOCIsIl9jYWxsZWU1IiwicyIsIl9jb250ZXh0NSIsIm5vdGUiLCJfeDUiLCJzdGF0ZSIsInN3YXAiLCJfeDMiLCJfeDQiLCJkZWZhdWx0Iiwia25leCIsInBsdWdpbiIsIk1vZGVsIiwiY29uc3VtZUV2ZW50U3RyZWFtIiwicHJvamVjdGlvbiJdLCJtYXBwaW5ncyI6IjJGQUFBLElBQUFBLE9BQUFDLFFBQUEsU0FDQUMsV0FBQUMsdUJBQUFGLFFBQUEsNnpDQUVBLElBQU1HLGdCQUFrQixJQUNsQkMsZUFBaUIsR0FFdkIsU0FBU0MsZ0JBQWdCQyxHQU56QixPQUFBQyxjQUFBLENBUUlDLFVBQVdGLEVBQU1FLFVBUHJCQyxZQUFBSCxFQUFBRyxZQVNJQyxVQUFXSixFQUFNSSxVQUNqQkMsS0FBTUwsRUFBTUssS0FDWkMsZUFBZ0JOLEVBQU1NLGVBQ3RCQyxNQUFPUCxFQUFNTyxNQUNiQyxTQUFVQyxLQUFLQyxNQUFNVixFQUFNUSxXQUN4QkMsS0FBS0MsTUFBTVYsRUFBTVcsV0FJSEMsc0JBQ25CLFNBQUFBLEVBQUFDLEdBQWtELElBQUFDLEVBQUFDLEtBQXBDQyxFQUFvQ0gsRUFBcENHLEdBQUlDLEVBQWdDSixFQUFoQ0ksZ0JBQWlCQyxFQUFlTCxFQUFmSyxZQUFlQyxnQkFBQUosS0FBQUgsR0FBQVEsZ0JBQUFMLEtBQUEscUJBQUFNLGtCQUFBQyxtQkFBQUMsS0F3QzdCLFNBQUFDLElBQUEsSUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQSxPQUFBUCxtQkFBQVEsS0FBQSxTQUFBQyxHQUFBLE9BQUEsT0FBQUEsRUFBQUMsS0FBQUQsRUFBQUUsTUFBQSxLQUFBLEVBQUEsT0FBQUYsRUFBQUUsS0FBQSxFQUFBbkIsRUFBQUcsZ0JBQUFRLFdBQUEsS0FBQSxFQUFBLE9BQUFBLEVBQUFNLEVBQUFHLEtBQUFILEVBQUFFLEtBQUEsRUFBQW5CLEVB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UkEsRUFBQUUsVUFLRUksS0FBY04sRUFBRUEsS0FDVEEsTUFBTU8sSUFDSEUsUUFBS0MsSUFBTEQsRUFBQUEsSUFYZCxLQUFBLEVBQUEsSUFBQSxNQUFBLE9BQUEyRSxFQUFBdkMsU0FBQXFDLEVBQUEsS0FBQSxDQUFBLENBQUEsRUFBQSxRQUF3QixPQUFBLFNBQUFJLEdBQUEsT0FBQUwsRUFBQWQsTUFBQXBELEtBQUFxRCxZQUFBLEtBc0JELEtBQUEsRUFBQSxHQWdCYyxjQUEzQnRELEVBQUtJLFlBQVlxRSxPQUFpRCxJQUF4QnpFLEVBQUt3QixNQUFNRixTQWhCeEMsT0FBQTBDLEVBQUE3QyxLQUFBLEVBaUJUbkIsRUFBS0ksWUFBWXNFLEtBakJSVixFQUFBN0MsS0FBQSxFQUFBLE1BQUEsS0FBQSxFQUFBLEdBQUE2QyxFQUFBaEIsR0FBQWdCLEVBQUE1QyxNQUFBNEMsRUFBQWhCLEdBQUEsQ0FBQWdCLEVBQUE3QyxLQUFBLEVBQUEsTUFpQmdCbkIsRUFBS0ksWUFBWXNFLE9BakJqQyxLQUFBLEVBQUEsT0FBQVYsRUFBQWxDLE9BQUEsU0FtQlZpQyxLQW5CVSxLQUFBLEdBQUEsSUFBQSxNQUFBLE9BQUFDLEVBQUFqQyxTQUFBK0IsTUFBTixPQUFBLFNBQUFhLEVBQUFDLEdBQUEsT0FBQWYsRUFBQVIsTUFBQXBELEtBQUFxRCxZQUFBLElBc0JickQsS0FBS3FDLE9BQVEsRUFBQXpELFdBQUFnRyxTQUFVM0UsRUFBRzRFLEtBQUssZUEzQmlCQyxPQUFBLGNBQUFDLE1BQWhDN0UsT0FBQUEsQ0FBaUJDLFVBQUFBLFdBaUNqQ0gsS0FBS2dGLDRFQWpDMkNDLEdBQUFqRixLQUFBMkQsY0FBQW5DLEtBQUF5RCIsImZpbGUiOiJzcWxFdmVudEZlZWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBxdWV1ZSB9IGZyb20gJ2FzeW5jJztcbmltcG9ydCBib29rc2hlbGYgZnJvbSAnYm9va3NoZWxmJztcblxuY29uc3QgcG9sbGluZ0ludGVydmFsID0gMTAwO1xuY29uc3QgZXZlbnRCYXRjaFNpemUgPSAxMDtcblxuZnVuY3Rpb24gZnJvbVN0b3JlZEV2ZW50KGV2ZW50KSB7XG4gIHJldHVybiB7XG4gICAgYWdncmVnYXRlOiBldmVudC5hZ2dyZWdhdGUsXG4gICAgYWdncmVnYXRlSWQ6IGV2ZW50LmFnZ3JlZ2F0ZUlkLFxuICAgIHRpbWVzdGFtcDogZXZlbnQudGltZXN0YW1wLFxuICAgIHR5cGU6IGV2ZW50LnR5cGUsXG4gICAgc2VxdWVuY2VOdW1iZXI6IGV2ZW50LnNlcXVlbmNlTnVtYmVyLFxuICAgIGFjdG9yOiBldmVudC5hY3RvcixcbiAgICBwb3NpdGlvbjogSlNPTi5wYXJzZShldmVudC5wb3NpdGlvbiksXG4gICAgLi4uSlNPTi5wYXJzZShldmVudC5ib2R5KVxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFdmVudFN0b3JlIHtcbiAgY29uc3RydWN0b3IoeyBkYiwgcHJvamVjdGlvblN0YXRlLCBhY3RpdmVTdGF0ZSB9KSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gW107XG4gICAgdGhpcy5wcm9qZWN0aW9uU3RhdGUgPSBwcm9qZWN0aW9uU3RhdGU7XG4gICAgdGhpcy5hY3RpdmVTdGF0ZSA9IGFjdGl2ZVN0YXRlO1xuXG4gICAgdGhpcy5xdWV1ZSA9IHF1ZXVlKGFzeW5jIChldmVudCwgY2FsbGJhY2spID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGBFdmVudDogJHtldmVudC5hZ2dyZWdhdGVJZH0gJHtldmVudC5hZ2dyZWdhdGV9LiR7ZXZlbnQudHlwZX1gKTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMuc3Vic2NyaXB0aW9ucy5tYXAoYXN5bmMgcyA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmV0dXJuIGF3YWl0IHMoZXZlbnQpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBnbG9iYWwubG9nID8gZ2xvYmFsLmxvZy5ub3RlKHtcbiAgICAgICAgICAgIGVycm9yOiBlcnIsXG4gICAgICAgICAgICBhZ2dyZWdhdGVJZDogZXZlbnQuYWdncmVnYXRlSWQsXG4gICAgICAgICAgICBhZ2dyZWdhdGU6IGV2ZW50LmFnZ3JlZ2F0ZSxcbiAgICAgICAgICAgIHR5cGU6IGV2ZW50LnR5cGUsXG4gICAgICAgICAgICBldmVudDogZXZlbnRcbiAgICAgICAgICB9KSA6IGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pKTtcbiAgICAgIGlmICh0aGlzLmFjdGl2ZVN0YXRlLnN0YXRlID09PSAncmVzZXR0aW5nJyAmJiB0aGlzLnF1ZXVlLmxlbmd0aCgpID09PSAwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWN0aXZlU3RhdGUuc3dhcCAmJiB0aGlzLmFjdGl2ZVN0YXRlLnN3YXAoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBjYWxsYmFjaygpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5FdmVudCA9IGJvb2tzaGVsZihkYi5rbmV4KCdldmVudHN0b3JlJykpXG4gICAgICAucGx1Z2luKCdwYWdpbmF0aW9uJylcbiAgICAgIC5Nb2RlbC5leHRlbmQoe1xuICAgICAgICB0YWJsZU5hbWU6ICdldmVudHMnXG4gICAgICB9KTtcblxuICAgIHRoaXMuY29uc3VtZUV2ZW50U3RyZWFtKCk7XG4gIH1cblxuICBzdWJzY3JpYmUocHJvamVjdGlvbikge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKHByb2plY3Rpb24pO1xuICB9XG5cbiAgY29uc3VtZUV2ZW50U3RyZWFtID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCBib29rbWFyayA9IGF3YWl0IHRoaXMucHJvamVjdGlvblN0YXRlLmJvb2ttYXJrKCk7XG4gICAgbGV0IHsgZXZlbnRzLCBib29rbWFyazogbmV3Qm9va21hcmssIGxhc3RCb29rbWFyayB9ID0gYXdhaXQgdGhpcy5nZXROZXh0RXZlbnRzKGJvb2ttYXJrKTtcblxuICAgIGlmIChldmVudHMubGVuZ3RoKSB7XG4gICAgICBldmVudHMuZm9yRWFjaChldmVudCA9PiB7XG4gICAgICAgIHRoaXMucXVldWUucHVzaChldmVudCk7XG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUuc2V0Qm9va21hcmsobmV3Qm9va21hcmspO1xuICAgIH1cbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IGF3YWl0IHRoaXMuY29uc3VtZUV2ZW50U3RyZWFtKCksIG5ld0Jvb2ttYXJrIDwgbGFzdEJvb2ttYXJrID8gMCA6IHBvbGxpbmdJbnRlcnZhbCk7XG4gIH1cblxuICBnZXROZXh0RXZlbnRzID0gYXN5bmMgYm9va21hcmsgPT4ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgZXZlbnRzID0gKGF3YWl0IHRoaXMuRXZlbnRcbiAgICAgICAgLndoZXJlKCdpZCcsICc+JywgYm9va21hcmspXG4gICAgICAgIC5xdWVyeShxYiA9PiBxYi5vcmRlckJ5KCdpZCcsICdhc2MnKSlcbiAgICAgICAgLmZldGNoUGFnZSh7IHBhZ2VTaXplOiBldmVudEJhdGNoU2l6ZSB9KVxuICAgICAgKS50b0pTT04oKTtcblxuICAgICAgbGV0IG5ld0Jvb2ttYXJrID0gYm9va21hcms7XG4gICAgICBpZiAoZXZlbnRzLmxlbmd0aCkge1xuICAgICAgICBsZXQgeyBsZW5ndGg6IGwsIFtsIC0gMV06IGxhc3RFdmVudCB9ID0gZXZlbnRzO1xuICAgICAgICBuZXdCb29rbWFyayA9IGxhc3RFdmVudC5pZDtcbiAgICAgIH1cblxuICAgICAgbGV0IGxhc3RSZWNvcmQgPSAoYXdhaXQgdGhpcy5FdmVudC5xdWVyeShxYiA9PiBxYi5vcmRlckJ5KCdpZCcsICdkZXNjJykpLmZldGNoUGFnZSh7IHBhZ2VTaXplOiAxIH0pKS50b0pTT04oKVswXTtcbiAgICAgIGxldCBsYXN0Qm9va21hcmsgPSBsYXN0UmVjb3JkICYmIGxhc3RSZWNvcmQuaWQ7XG5cbiAgICAgIHJldHVybiB7IGV2ZW50czogZXZlbnRzLm1hcChlID0+IGZyb21TdG9yZWRFdmVudChlKSksIGJvb2ttYXJrOiBuZXdCb29rbWFyaywgbGFzdEJvb2ttYXJrIH07XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5jb2RlICE9PSAnRVJfQkFEX0RCX0VSUk9SJykge1xuICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgbG9hZGluZyBldmVudHMnLCBlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7IGV2ZW50czogW10sIGJvb2ttYXJrOiBib29rbWFyayB9O1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0ID0gYXN5bmMgYWN0aXZlU3RhdGUgPT4ge1xuICAgIGF3YWl0IHRoaXMucHJvamVjdGlvblN0YXRlLnJlc2V0KGFjdGl2ZVN0YXRlKTtcbiAgfVxufVxuIl19
