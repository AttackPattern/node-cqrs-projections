"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _async=require("async"),_bookshelf=_interopRequireDefault(require("bookshelf"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,t,r,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(u){return function(){var e=this,s=arguments;return new Promise(function(t,r){var n=u.apply(e,s);function a(e){asyncGeneratorStep(n,t,r,a,o,"next",e)}function o(e){asyncGeneratorStep(n,t,r,a,o,"throw",e)}a(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var pollingInterval=100,eventBatchSize=10;function fromStoredEvent(e){return _objectSpread({aggregate:e.aggregate,aggregateId:e.aggregateId,timestamp:e.timestamp,type:e.type,sequenceNumber:e.sequenceNumber,actor:e.actor,position:JSON.parse(e.position)},JSON.parse(e.body))}var EventStore=function(){function a(e){var i=this,t=e.db,r=e.projectionState,n=e.stores;_classCallCheck(this,a),_defineProperty(this,"consumeEventStream",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.projectionState.bookmark();case 2:return t=e.sent,e.next=5,i.getNextEvents(t);case 5:if(r=e.sent,n=r.events,a=r.bookmark,o=r.lastBookmark,!("starting"===i.currentState&&o<=a&&0===i.queue.length())){e.next=14;break}console.log('Projections is now built and entering "Running" state'),i.setState("running"),e.next=18;break;case 14:if("resetting"===i.currentState&&o<=a&&0===i.queue.length())return console.log("we are prob done resetting"),e.next=18,i.finishReset();e.next=18;break;case 18:if(n.length)return n.forEach(function(e){i.queue.push(e)}),e.next=22,i.projectionState.setBookmark(a);e.next=22;break;case 22:setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.consumeEventStream();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)})),a<o?0:pollingInterval);case 23:case"end":return e.stop()}},e)}))),_defineProperty(this,"getNextEvents",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,o,s,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.Event.where("id",">",t).query(function(e){return e.orderBy("id","asc")}).fetchPage({pageSize:eventBatchSize});case 3:return r=e.sent.toJSON(),n=t,r.length&&(a=r.length,o=r[a-1],n=o.id),e.next=8,i.Event.query(function(e){return e.orderBy("id","desc")}).fetchPage({pageSize:1});case 8:return s=e.sent.toJSON()[0],u=s&&s.id,e.abrupt("return",{events:r.map(function(e){return fromStoredEvent(e)}),bookmark:n,lastBookmark:u});case 13:return e.prev=13,e.t0=e.catch(0),"ER_BAD_DB_ERROR"!==e.t0.code&&console.log("Error loading events",e.t0),e.abrupt("return",{events:[],bookmark:t});case 17:case"end":return e.stop()}},e,null,[[0,13]])}));return function(e){return t.apply(this,arguments)}}()),_defineProperty(this,"reset",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.projectionState.reset(t);case 2:i.setState("resetting");case 3:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),this.subscriptions=[],this.projectionState=r,this.currentState="starting",this.stores=n,this.queue=(0,_async.queue)(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Event: ".concat(r.aggregateId," ").concat(r.aggregate,".").concat(r.type)),e.next=3,Promise.all(i.subscriptions.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t(r);case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),global.log?global.log.note({error:e.t0,aggregateId:r.aggregateId,aggregate:r.aggregate,type:r.type,event:r}):console.log(e.t0);case 9:case"end":return e.stop()}},e,null,[[0,6]])}));return function(e){return t.apply(this,arguments)}}()));case 3:return e.abrupt("return",t());case 4:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}()),this.Event=(0,_bookshelf.default)(t.knex("eventstore")).Model.extend({tableName:"events"}),this.consumeEventStream()}var e;return _createClass(a,[{key:"finishReset",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.stores.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.swap,e.t0)return e.next=4,t.swap();e.next=5;break;case 4:e.t0=e.sent;case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()));case 2:this.setState("running");case 3:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"subscribe",value:function(e){this.subscriptions.push(e)}},{key:"getState",value:function(){return this.currentState}},{key:"setState",value:function(e){this.currentState=e}}]),a}();exports.default=EventStore;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNxbEV2ZW50RmVlZC5qcyJdLCJuYW1lcyI6WyJfYXN5bmMiLCJyZXF1aXJlIiwiX2Jvb2tzaGVsZiIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJwb2xsaW5nSW50ZXJ2YWwiLCJldmVudEJhdGNoU2l6ZSIsImZyb21TdG9yZWRFdmVudCIsImV2ZW50IiwiX29iamVjdFNwcmVhZCIsImFnZ3JlZ2F0ZSIsImFnZ3JlZ2F0ZUlkIiwidGltZXN0YW1wIiwidHlwZSIsInNlcXVlbmNlTnVtYmVyIiwiYWN0b3IiLCJwb3NpdGlvbiIsIkpTT04iLCJwYXJzZSIsImJvZHkiLCJFdmVudFN0b3JlIiwiX3JlZiIsIl90aGlzIiwidGhpcyIsImRiIiwicHJvamVjdGlvblN0YXRlIiwic3RvcmVzIiwiX2NsYXNzQ2FsbENoZWNrIiwiX2RlZmluZVByb3BlcnR5IiwiX2FzeW5jVG9HZW5lcmF0b3IiLCJyZWdlbmVyYXRvclJ1bnRpbWUiLCJtYXJrIiwiX2NhbGxlZTIiLCJib29rbWFyayIsIl9yZWYzIiwiZXZlbnRzIiwibmV3Qm9va21hcmsiLCJsYXN0Qm9va21hcmsiLCJ3cmFwIiwiX2NvbnRleHQyIiwicHJldiIsIm5leHQiLCJzZW50IiwiZ2V0TmV4dEV2ZW50cyIsImN1cnJlbnRTdGF0ZSIsInF1ZXVlIiwibGVuZ3RoIiwiY29uc29sZSIsImxvZyIsInNldFN0YXRlIiwiZmluaXNoUmVzZXQiLCJmb3JFYWNoIiwicHVzaCIsInNldEJvb2ttYXJrIiwic2V0VGltZW91dCIsIl9jYWxsZWUiLCJfY29udGV4dCIsImNvbnN1bWVFdmVudFN0cmVhbSIsImFicnVwdCIsInN0b3AiLCJfcmVmNSIsIl9jYWxsZWUzIiwibCIsImxhc3RFdmVudCIsImxhc3RSZWNvcmQiLCJfY29udGV4dDMiLCJ3aGVyZSIsInF1ZXJ5IiwicWIiLCJvcmRlckJ5IiwiZmV0Y2hQYWdlIiwicGFnZVNpemUiLCJ0b0pTT04iLCJpZCIsIkV2ZW50IiwibWFwIiwiZSIsInQwIiwiY29kZSIsIl94IiwiYXBwbHkiLCJhcmd1bWVudHMiLCJfcmVmNiIsIl9jYWxsZWU0Iiwia2V5IiwiX2NvbnRleHQ0IiwicmVzZXQiLCJfeDIiLCJzdWJzY3JpcHRpb25zIiwiX3JlZjciLCJfY2FsbGVlNiIsImNhbGxiYWNrIiwiX2NvbnRleHQ2IiwiY29uY2F0IiwiYWxsIiwiX3JlZjgiLCJfY2FsbGVlNSIsInMiLCJfY29udGV4dDUiLCJub3RlIiwiX3g1IiwiX3gzIiwiX3g0Iiwia25leCIsIk1vZGVsIiwiZXh0ZW5kIiwidGFibGVOYW1lIiwiUHJvbWlzZSIsIl9yZWY5IiwiX2NhbGxlZTciLCJwIiwiX2NvbnRleHQ3Iiwic3dhcCIsIl94NiIsInByb2plY3Rpb24iLCJzdGF0ZSJdLCJtYXBwaW5ncyI6IjJGQUFBLElBQUFBLE9BQUFDLFFBQUEsU0FDQUMsV0FBQUMsdUJBQUFGLFFBQUEsb2tEQUVBLElBQU1HLGdCQUFrQixJQUNsQkMsZUFBaUIsR0FFdkIsU0FBU0MsZ0JBQWdCQyxHQU56QixPQUFBQyxjQUFBLENBUUlDLFVBQVdGLEVBQU1FLFVBUHJCQyxZQUFBSCxFQUFBRyxZQVNJQyxVQUFXSixFQUFNSSxVQUNqQkMsS0FBTUwsRUFBTUssS0FDWkMsZUFBZ0JOLEVBQU1NLGVBQ3RCQyxNQUFPUCxFQUFNTyxNQUNiQyxTQUFVQyxLQUFLQyxNQUFNVixFQUFNUSxXQUN4QkMsS0FBS0MsTUFBTVYsRUFBTVcsV0FJSEMsc0JBQ25CLFNBQUFBLEVBQUFDLEdBQTZDLElBQUFDLEVBQUFDLEtBQS9CQyxFQUErQkgsRUFBL0JHLEdBQUlDLEVBQTJCSixFQUEzQkksZ0JBQWlCQyxFQUFVTCxFQUFWSyxPQUFVQyxnQkFBQUosS0FBQUgsR0FBQVEsZ0JBQUFMLEtBQUEscUJBQUFNLGtCQUFBQyxtQkFBQUMsS0FrRHhCLFNBQUFDLElBQUEsSUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQSxPQUFBUCxtQkFBQVEsS0FBQSxTQUFBQyxHQUFBLE9BQUEsT0FBQUEsRUFBQUMsS0FBQUQsRUFBQUUsTUFBQSxLQUFBLEVBQUEsT0FBQUYsRUFBQUUsS0FBQSxFQUFBbkIsRUFBQUcsZ0JBQUFRLFdBQUEsS0FBQSxFQUFBLE9BQ2ZBLEVBRGVNLEVBQUFHLEtBQUFILEVBQUFFLEtBQUEsRUFBQW5CLEVBQUFxQixjQUFBVixHQUFBLEtBQUEsRUFBQSxHQUFBQyxFQUFBSyxFQUFBRyxLQUFBUCxFQUFBRCxFQUFBQyxPQUFBQyxFQUFBRixFQUFBRCxTQUFBSSxFQUFBSCxFQUFBRyxlQUlPLGFBQXRCZixFQUFLc0IsY0FBOENQLEdBQWZELEdBQXVELElBQXhCZCxFQUFLdUIsTUFBTUMsVUFKL0QsQ0FBQVAsRUFBQUUsS0FBQSxHQUFBLE1BQUFNLFFBQUFDLElBQUEseURBQUExQixFQUFBMkIsU0FBQSxXQUFBVixFQUFBRSxLQUFBLEdBQUEsTUFBQSxLQUFBLEdBQUEsR0FFTFIsY0FBVUcsRUFBQUEsY0FGTEMsR0FBQUQsR0FBQSxJQUFBZCxFQUFBdUIsTUFBQUMsU0FBQSxPQUVrQlQsUUFBQUEsSUFBQUEsOEJBRmxCRSxFQUFBRSxLQUFBLEdBVVhuQixFQUFLNEIsY0FWTVgsRUFBQUUsS0FBQSxHQUFBLE1BQUEsS0FBQSxHQUFBLEdBQUFOLEVBQUFXLE9BQUEsT0FBQVgsRUFBQWdCLFFBQUEsU0FBQTNDLEdBQUFjLEVBQUF1QixNQUFBTyxLQUFBNUMsS0FBQStCLEVBQUFFLEtBQUEsR0FpQlhuQixFQUFLRyxnQkFBZ0I0QixZQUFZakIsR0FqQnRCRyxFQUFBRSxLQUFBLEdBQUEsTUFBQSxLQUFBLEdBbUJuQmEsV0FBVXpCLGtCQUFBQyxtQkFBQUMsS0FBQyxTQUFBd0IsSUFBQSxPQUFBekIsbUJBQUFRLEtBQUEsU0FBQWtCLEdBQUEsT0FBQSxPQUFBQSxFQUFBaEIsS0FBQWdCLEVBQUFmLE1BQUEsS0FBQSxFQUFBLE9BQUFlLEVBQUFmLEtBQUEsRUFBa0JuQixFQUFLbUMscUJBQXZCLEtBQUEsRUFBQSxPQUFBRCxFQUFBRSxPQUFBLFNBQUFGLEVBQUFkLE1BQUEsS0FBQSxFQUFBLElBQUEsTUFBQSxPQUFBYyxFQUFBRyxTQUFBSixNQUE2Q25CLEVBQWNDLEVBQWUsRUFBSWhDLGlCQW5CdEUsS0FBQSxHQUFBLElBQUEsTUFBQSxPQUFBa0MsRUFBQW9CLFNBQUEzQixPQWxEd0JKLGdCQUFBTCxLQUFBLGdCQUFBLFdBQUEsSUFBQXFDLEVBQUEvQixrQkFBQUMsbUJBQUFDLEtBd0U3QixTQUFBOEIsRUFBTTVCLEdBQU4sSUFBQUUsRUFBQUMsRUFBQTBCLEVBQUFDLEVBQUFDLEVBQUEzQixFQUFBLE9BQUFQLG1CQUFBUSxLQUFBLFNBQUEyQixHQUFBLE9BQUEsT0FBQUEsRUFBQXpCLEtBQUF5QixFQUFBeEIsTUFBQSxLQUFBLEVBQUEsT0FBQXdCLEVBQUF6QixLQUFBLEVBQUF5QixFQUFBeEIsS0FBQSxFQWRBRyxFQUFBQSxNQVJLc0IsTUFBQSxLQUFBLElBQUFqQyxHQUFBa0MsTUFBQSxTQUFBQyxHQUFBLE9BQUFBLEVBQUFDLFFBQUEsS0FBQSxTQUFBQyxVQUFBLENBQUFDLFNBQUFqRSxpQkFzQkwsS0FBQSxFQUFBLE9BdEJLNkIsRUFzQkw4QixFQUFBdkIsS0FNVjhCLFNBNUJlcEMsRUFBQUgsRUFBQUUsRUFBQVcsU0FnQ0RnQixFQUEwQjNCLEVBQWxDVyxPQUFvQmlCLEVBQWM1QixFQUF0QjJCLEVBQUksR0FoQ1AxQixFQUFBMkIsRUFBQVUsSUFzQkxSLEVBQUF4QixLQUFBLEVBdEJLbkIsRUFBQW9ELE1BQUFQLE1BQUEsU0FBQUMsR0FBQSxPQUFBQSxFQUFBQyxRQUFBLEtBQUEsVUFBQUMsVUFBQSxDQUFBQyxTQUFBLElBc0JMLEtBQUEsRUFBQSxPQXRCS1AsRUFzQkxDLEVBQUF2QixLQXRCSzhCLFNBQUEsR0FBQW5DLEVBQUEyQixHQUFBQSxFQUFBUyxHQXNCTFIsRUFBQVAsT0FBQSxTQVRadkIsQ0FBQUEsT0FBT2dCLEVBQVF3QixJQUFBLFNBQUFDLEdBQUEsT0FBQXBFLGdCQUFTb0UsS0FBQTNDLFNBQUFHLEVBQUFDLGFBQUFBLElBU1osS0FBQSxHQUFBLE9BQUE0QixFQUFBekIsS0FBQSxHQUFBeUIsRUFBQVksR0FBQVosRUFBQSxNQUFBLEdBdEJLLG9CQUFBQSxFQUFBWSxHQUFBQyxNQUFBL0IsUUFBQUMsSUFBQSx1QkFBQWlCLEVBQUFZLElBc0JMWixFQUFBUCxPQUFBLFNBdEJLLENBQUF2QixPQUFBLEdBQUFGLFNBQUFBLElBc0JMLEtBQUEsR0FBQSxJQUFBLE1BQUEsT0FBQWdDLEVBQUFOLFNBQUFFLEVBQUEsS0FBQSxDQUFBLENBQUEsRUFBQSxTQXhFNkIsT0FBQSxTQUFBa0IsR0FBQSxPQUFBbkIsRUFBQW9CLE1BQUF6RCxLQUFBMEQsWUFBQSxJQUFBckQsZ0JBQUFMLEtBQUEsUUFBQSxXQUFBLElBQUEyRCxFQUFBckQsa0JBQUFDLG1CQUFBQyxLQXFFakMsU0FBQW9ELEVBQUFDLEdBQUEsT0FBQXRELG1CQUFBUSxLQUFBLFNBQUErQyxHQUFBLE9BQUEsT0FBQUEsRUFBQTdDLEtBQUE2QyxFQUFBNUMsTUFBQSxLQUFBLEVBQUEsT0FBQTRDLEVBQUE1QyxLQUFBLEVBQUFuQixFQUFBRyxnQkFBQTZELE1BQUFGLEdBQUEsS0FBQSxFQUFDOUQsRUFBQTJCLFNBQUEsYUFBRCxLQUFBLEVBQUEsSUFBQSxNQUFBLE9BQUFvQyxFQUFBMUIsU0FBQXdCLE1BckVpQyxPQUFBLFNBQUFJLEdBQUEsT0FBQUwsRUFBQUYsTUFBQXpELEtBQUEwRCxZQUFBLElBQzNDMUQsS0FBS2lFLGNBQWdCLEdBQ3JCakUsS0FBS0UsZ0JBQWtCQSxFQUN2QkYsS0FBS3FCLGFBQWUsV0FDcEJyQixLQUFLRyxPQUFTQSxFQUdkSCxLQUFLc0IsT0FBUSxFQUFBNUMsT0FBQTRDLE9BQUEsV0FBQSxJQUFBNEMsRUFBQTVELGtCQUFBQyxtQkFBQUMsS0FBTSxTQUFBMkQsRUFBT2xGLEVBQU9tRixHQUFkLE9BQUE3RCxtQkFBQVEsS0FBQSxTQUFBc0QsR0FBQSxPQUFBLE9BQUFBLEVBQUFwRCxLQUFBb0QsRUFBQW5ELE1BQUEsS0FBQSxFQUFBLE9BQ2pCTSxRQUFRQyxJQUFSLFVBQUE2QyxPQUFzQnJGLEVBQU1HLFlBQTVCLEtBQUFrRixPQUEyQ3JGLEVBQU1FLFVBQWpELEtBQUFtRixPQUE4RHJGLEVBQU1LLE9BRG5EK0UsRUFBQW5ELEtBQUEsRUF4QmpCcEMsUUFBZXlGLElBQUd4RSxFQUF4QmtFLGNBQUFiLElBQXdCLFdBQUEsSUFBQW9CLEVBQUFsRSxrQkFBQUMsbUJBQUFDLEtBQXhCLFNBQUFpRSxFQUFBQyxHQUFBLE9BQUFuRSxtQkFBQVEsS0FBQSxTQUFBNEQsR0FBQSxPQUFBLE9BQUFBLEVBQUExRCxLQUFBMEQsRUFBQXpELE1BQUEsS0FBQSxFQUFBLE9BQUF5RCxFQUFBMUQsS0FBQSxFQUFBMEQsRUFBQXpELEtBQUEsRUE0QnVCd0QsRUFBRXpGLEdBNUJ6QixLQUFBLEVBQUEsT0FBQTBGLEVBQUF4QyxPQUFBLFNBQUF3QyxFQUFBeEQsTUFBQSxLQUFBLEVBQUF3RCxFQUFBMUQsS0FBQSxFQUFBMEQsRUFBQXJCLEdBQUFxQixFQUFBLE1BQUEsR0FLSXhGLE9BQVdGLElBQU1FLE9BRG5Cc0MsSUFBQW1ELEtBQUEsQ0FFRXhGLE1BQWFILEVBQUFBLEdBQ2JJLFlBQWlCQSxFQUhuQkQsWUFJUUgsVUFKUkEsRUFBQUUsVUFLRUksS0FBY04sRUFBRUEsS0FDVEEsTUFBTU8sSUFDSEUsUUFBS0MsSUFBTEQsRUFBQUEsSUFYZCxLQUFBLEVBQUEsSUFBQSxNQUFBLE9BQUFpRixFQUFBdkMsU0FBQXFDLEVBQUEsS0FBQSxDQUFBLENBQUEsRUFBQSxRQUF3QixPQUFBLFNBQUFJLEdBQUEsT0FBQUwsRUFBQWYsTUFBQXpELEtBQUEwRCxZQUFBLEtBd0JELEtBQUEsRUFBQSxPQUFBVyxFQUFBbEMsT0FBQSxTQWdCVmlDLEtBaEJVLEtBQUEsRUFBQSxJQUFBLE1BQUEsT0FBQUMsRUFBQWpDLFNBQUErQixNQUFOLE9BQUEsU0FBQVcsRUFBQUMsR0FBQSxPQUFBYixFQUFBVCxNQUFBekQsS0FBQTBELFlBQUEsSUFtQmIxRCxLQUFLbUQsT0FBUSxFQUFBdkUsV0FBQSxTQUFVcUIsRUFBRytFLEtBQUssZUExQmpDQyxNQUFBQyxPQUFBLENBQTZDQyxVQUFBLFdBQUFuRixLQUEzQkUsb09BbUNWa0YsUUFBUWIsSUFBSXZFLEtBQUtHLE9BQU9pRCxJQUFaLFdBQUEsSUFBQWlDLEVBQUEvRSxrQkFBQUMsbUJBQUFDLEtBQWdCLFNBQUE4RSxFQUFNQyxHQUFOLE9BQUFoRixtQkFBQVEsS0FBQSxTQUFBeUUsR0FBQSxPQUFBLE9BQUFBLEVBQUF2RSxLQUFBdUUsRUFBQXRFLE1BQUEsS0FBQSxFQUFBLEdBQUFzRSxFQUFBbEMsR0FBV2lDLEVBQUVFLEtBQWJELEVBQUFsQyxHQUFBLE9BQUFrQyxFQUFBdEUsS0FBQSxFQUEyQnFFLEVBQUVFLE9BQTdCRCxFQUFBdEUsS0FBQSxFQUFBLE1BQUEsS0FBQSxFQUFBc0UsRUFBQWxDLEdBQUFrQyxFQUFBckUsS0FBQSxLQUFBLEVBQUEsT0FBQXFFLEVBQUFyRCxPQUFBLFNBQUFxRCxFQUFBbEMsSUFBQSxLQUFBLEVBQUEsSUFBQSxNQUFBLE9BQUFrQyxFQUFBcEQsU0FBQWtELE1BQWhCLE9BQUEsU0FBQUksR0FBQSxPQUFBTCxFQUFBNUIsTUFBQXpELEtBQUEwRCxZQUFBLFlBbkN5QjFELEtBQUEwQixTQUFBLHNJQUFBaUUsR0FBQTNGLEtBQUFpRSxjQUFBcEMsS0FrRHhCOEQsc0NBQUEsT0FBQTNGLEtBQUFxQiw4Q0FBQXVFLEdBQUE1RixLQUFBcUIsYUFBQXVFIiwiZmlsZSI6InNxbEV2ZW50RmVlZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHF1ZXVlIH0gZnJvbSAnYXN5bmMnO1xuaW1wb3J0IGJvb2tzaGVsZiBmcm9tICdib29rc2hlbGYnO1xuXG5jb25zdCBwb2xsaW5nSW50ZXJ2YWwgPSAxMDA7XG5jb25zdCBldmVudEJhdGNoU2l6ZSA9IDEwO1xuXG5mdW5jdGlvbiBmcm9tU3RvcmVkRXZlbnQoZXZlbnQpIHtcbiAgcmV0dXJuIHtcbiAgICBhZ2dyZWdhdGU6IGV2ZW50LmFnZ3JlZ2F0ZSxcbiAgICBhZ2dyZWdhdGVJZDogZXZlbnQuYWdncmVnYXRlSWQsXG4gICAgdGltZXN0YW1wOiBldmVudC50aW1lc3RhbXAsXG4gICAgdHlwZTogZXZlbnQudHlwZSxcbiAgICBzZXF1ZW5jZU51bWJlcjogZXZlbnQuc2VxdWVuY2VOdW1iZXIsXG4gICAgYWN0b3I6IGV2ZW50LmFjdG9yLFxuICAgIHBvc2l0aW9uOiBKU09OLnBhcnNlKGV2ZW50LnBvc2l0aW9uKSxcbiAgICAuLi5KU09OLnBhcnNlKGV2ZW50LmJvZHkpXG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEV2ZW50U3RvcmUge1xuICBjb25zdHJ1Y3Rvcih7IGRiLCBwcm9qZWN0aW9uU3RhdGUsIHN0b3JlcyB9KSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gW107XG4gICAgdGhpcy5wcm9qZWN0aW9uU3RhdGUgPSBwcm9qZWN0aW9uU3RhdGU7XG4gICAgdGhpcy5jdXJyZW50U3RhdGUgPSAnc3RhcnRpbmcnO1xuICAgIHRoaXMuc3RvcmVzID0gc3RvcmVzO1xuXG5cbiAgICB0aGlzLnF1ZXVlID0gcXVldWUoYXN5bmMgKGV2ZW50LCBjYWxsYmFjaykgPT4ge1xuICAgICAgY29uc29sZS5sb2coYEV2ZW50OiAke2V2ZW50LmFnZ3JlZ2F0ZUlkfSAke2V2ZW50LmFnZ3JlZ2F0ZX0uJHtldmVudC50eXBlfWApO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5zdWJzY3JpcHRpb25zLm1hcChhc3luYyBzID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgcyhldmVudCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgIGdsb2JhbC5sb2cgPyBnbG9iYWwubG9nLm5vdGUoe1xuICAgICAgICAgICAgZXJyb3I6IGVycixcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZUlkOiBldmVudC5hZ2dyZWdhdGVJZCxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZTogZXZlbnQuYWdncmVnYXRlLFxuICAgICAgICAgICAgdHlwZTogZXZlbnQudHlwZSxcbiAgICAgICAgICAgIGV2ZW50OiBldmVudFxuICAgICAgICAgIH0pIDogY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSkpO1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLkV2ZW50ID0gYm9va3NoZWxmKGRiLmtuZXgoJ2V2ZW50c3RvcmUnKSlcbiAgICAgIC5Nb2RlbC5leHRlbmQoe1xuICAgICAgICB0YWJsZU5hbWU6ICdldmVudHMnXG4gICAgICB9KTtcblxuICAgIHRoaXMuY29uc3VtZUV2ZW50U3RyZWFtKCk7XG4gIH1cblxuICBhc3luYyBmaW5pc2hSZXNldCgpIHtcbiAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnN0b3Jlcy5tYXAoYXN5bmMgcCA9PiBwLnN3YXAgJiYgYXdhaXQgcC5zd2FwKCkpKTtcbiAgICB0aGlzLnNldFN0YXRlKCdydW5uaW5nJyk7XG4gIH1cblxuICBzdWJzY3JpYmUocHJvamVjdGlvbikge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKHByb2plY3Rpb24pO1xuICB9XG5cbiAgZ2V0U3RhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlO1xuICB9XG4gIHNldFN0YXRlKHN0YXRlKSB7XG4gICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZTtcbiAgfVxuXG4gIGNvbnN1bWVFdmVudFN0cmVhbSA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgYm9va21hcmsgPSBhd2FpdCB0aGlzLnByb2plY3Rpb25TdGF0ZS5ib29rbWFyaygpO1xuICAgIGxldCB7IGV2ZW50cywgYm9va21hcms6IG5ld0Jvb2ttYXJrLCBsYXN0Qm9va21hcmsgfSA9IGF3YWl0IHRoaXMuZ2V0TmV4dEV2ZW50cyhib29rbWFyayk7XG4gICAgLy8gaWYgd2UgZGVsZXRlIGFuIGV2ZW50IGF0IHRoZSB0b3AgYW5kIHJlc3RhcnQsIHdlIGNhbiBlbmQgdXAgd2l0aCBhIG5ld0Jvb2ttYXJrID4gbGFzdCAodmVyc3VzID09PSlcbiAgICBpZiAodGhpcy5jdXJyZW50U3RhdGUgPT09ICdzdGFydGluZycgJiYgbmV3Qm9va21hcmsgPj0gbGFzdEJvb2ttYXJrICYmIHRoaXMucXVldWUubGVuZ3RoKCkgPT09IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKCdQcm9qZWN0aW9ucyBpcyBub3cgYnVpbHQgYW5kIGVudGVyaW5nIFwiUnVubmluZ1wiIHN0YXRlJyk7XG4gICAgICB0aGlzLnNldFN0YXRlKCdydW5uaW5nJyk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHRoaXMuY3VycmVudFN0YXRlID09PSAncmVzZXR0aW5nJyAmJiBuZXdCb29rbWFyayA+PSBsYXN0Qm9va21hcmsgJiYgdGhpcy5xdWV1ZS5sZW5ndGgoKSA9PT0gMCkge1xuICAgICAgY29uc29sZS5sb2coJ3dlIGFyZSBwcm9iIGRvbmUgcmVzZXR0aW5nJyk7XG4gICAgICBhd2FpdCB0aGlzLmZpbmlzaFJlc2V0KCk7XG4gICAgfVxuICAgIGlmIChldmVudHMubGVuZ3RoKSB7XG4gICAgICBldmVudHMuZm9yRWFjaChldmVudCA9PiB7XG4gICAgICAgIHRoaXMucXVldWUucHVzaChldmVudCk7XG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUuc2V0Qm9va21hcmsobmV3Qm9va21hcmspO1xuICAgIH1cbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IGF3YWl0IHRoaXMuY29uc3VtZUV2ZW50U3RyZWFtKCksIG5ld0Jvb2ttYXJrIDwgbGFzdEJvb2ttYXJrID8gMCA6IHBvbGxpbmdJbnRlcnZhbCk7XG4gIH1cblxuICBnZXROZXh0RXZlbnRzID0gYXN5bmMgYm9va21hcmsgPT4ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgZXZlbnRzID0gKGF3YWl0IHRoaXMuRXZlbnRcbiAgICAgICAgLndoZXJlKCdpZCcsICc+JywgYm9va21hcmspXG4gICAgICAgIC5xdWVyeShxYiA9PiBxYi5vcmRlckJ5KCdpZCcsICdhc2MnKSlcbiAgICAgICAgLmZldGNoUGFnZSh7IHBhZ2VTaXplOiBldmVudEJhdGNoU2l6ZSB9KVxuICAgICAgKS50b0pTT04oKTtcblxuICAgICAgbGV0IG5ld0Jvb2ttYXJrID0gYm9va21hcms7XG4gICAgICBpZiAoZXZlbnRzLmxlbmd0aCkge1xuICAgICAgICBsZXQgeyBsZW5ndGg6IGwsIFtsIC0gMV06IGxhc3RFdmVudCB9ID0gZXZlbnRzO1xuICAgICAgICBuZXdCb29rbWFyayA9IGxhc3RFdmVudC5pZDtcbiAgICAgIH1cblxuICAgICAgbGV0IGxhc3RSZWNvcmQgPSAoYXdhaXQgdGhpcy5FdmVudC5xdWVyeShxYiA9PiBxYi5vcmRlckJ5KCdpZCcsICdkZXNjJykpLmZldGNoUGFnZSh7IHBhZ2VTaXplOiAxIH0pKS50b0pTT04oKVswXTtcbiAgICAgIGxldCBsYXN0Qm9va21hcmsgPSBsYXN0UmVjb3JkICYmIGxhc3RSZWNvcmQuaWQ7XG5cbiAgICAgIHJldHVybiB7IGV2ZW50czogZXZlbnRzLm1hcChlID0+IGZyb21TdG9yZWRFdmVudChlKSksIGJvb2ttYXJrOiBuZXdCb29rbWFyaywgbGFzdEJvb2ttYXJrIH07XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5jb2RlICE9PSAnRVJfQkFEX0RCX0VSUk9SJykge1xuICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgbG9hZGluZyBldmVudHMnLCBlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7IGV2ZW50czogW10sIGJvb2ttYXJrOiBib29rbWFyayB9O1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0ID0gYXN5bmMga2V5ID0+IHtcbiAgICBhd2FpdCB0aGlzLnByb2plY3Rpb25TdGF0ZS5yZXNldChrZXkpO1xuICAgIHRoaXMuc2V0U3RhdGUoJ3Jlc2V0dGluZycpO1xuICB9XG59XG4iXX0=
