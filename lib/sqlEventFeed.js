"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _async=require("async"),_bookshelf=_interopRequireDefault(require("bookshelf"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,t,r,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void r(e)}u.done?t(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(u){return function(){var e=this,s=arguments;return new Promise(function(t,r){var n=u.apply(e,s);function a(e){asyncGeneratorStep(n,t,r,a,o,"next",e)}function o(e){asyncGeneratorStep(n,t,r,a,o,"throw",e)}a(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(r,!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(r).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var pollingInterval=100,eventBatchSize=10;function fromStoredEvent(e){return _objectSpread({aggregate:e.aggregate,aggregateId:e.aggregateId,timestamp:e.timestamp,type:e.type,sequenceNumber:e.sequenceNumber,actor:e.actor,position:JSON.parse(e.position)},JSON.parse(e.body))}var EventStore=function(){function a(e){var i=this,t=e.db,r=e.projectionState,n=e.stores;_classCallCheck(this,a),_defineProperty(this,"consumeEventStream",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.projectionState.bookmark();case 2:return t=e.sent,e.next=5,i.getNextEvents(t);case 5:if(r=e.sent,n=r.events,a=r.bookmark,o=r.lastBookmark,!("starting"===i.currentState&&o<=a&&0===i.queue.length())){e.next=14;break}console.log('Projections is now built and entering "Running" state'),i.setState("running"),e.next=18;break;case 14:if("resetting"===i.currentState&&o<=a&&0===i.queue.length())return console.log("we are prob done resetting"),e.next=18,i.finishReset();e.next=18;break;case 18:if(n.length)return n.forEach(function(e){i.queue.push(e)}),e.next=22,i.projectionState.setBookmark(a);e.next=22;break;case 22:setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.consumeEventStream();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)})),a<o?0:pollingInterval);case 23:case"end":return e.stop()}},e)}))),_defineProperty(this,"getNextEvents",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,o,s,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.Event.where("id",">",t).query(function(e){return e.orderBy("id","asc")}).fetchPage({pageSize:eventBatchSize});case 3:return r=e.sent.toJSON(),n=t,r.length&&(a=r.length,o=r[a-1],n=o.id),e.next=8,i.Event.query(function(e){return e.orderBy("id","desc")}).fetchPage({pageSize:1});case 8:return s=e.sent.toJSON()[0],u=s&&s.id,e.abrupt("return",{events:r.map(function(e){return fromStoredEvent(e)}),bookmark:n,lastBookmark:u});case 13:return e.prev=13,e.t0=e.catch(0),"ER_BAD_DB_ERROR"!==e.t0.code&&console.log("Error loading events",e.t0),e.abrupt("return",{events:[],bookmark:t});case 17:case"end":return e.stop()}},e,null,[[0,13]])}));return function(e){return t.apply(this,arguments)}}()),_defineProperty(this,"reset",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.projectionState.reset(t);case 2:i.setState("resetting");case 3:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),this.subscriptions=[],this.projectionState=r,this.currentState="starting",this.stores=n,this.queue=(0,_async.queue)(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Event: ".concat(r.aggregateId," ").concat(r.aggregate,".").concat(r.type)),e.next=3,Promise.all(i.subscriptions.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t(r);case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),global.log?global.log.note({error:e.t0,aggregateId:r.aggregateId,aggregate:r.aggregate,type:r.type,event:r}):console.log(e.t0);case 9:case"end":return e.stop()}},e,null,[[0,6]])}));return function(e){return t.apply(this,arguments)}}()));case 3:return e.abrupt("return",t());case 4:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}()),this.Event=(0,_bookshelf.default)(t.knex("eventstore")).plugin("pagination").Model.extend({tableName:"events"}),this.consumeEventStream()}var e;return _createClass(a,[{key:"finishReset",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.stores.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.swap,e.t0)return e.next=4,t.swap();e.next=5;break;case 4:e.t0=e.sent;case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()));case 2:this.setState("running");case 3:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"subscribe",value:function(e){this.subscriptions.push(e)}},{key:"getState",value:function(){return this.currentState}},{key:"setState",value:function(e){this.currentState=e}}]),a}();exports.default=EventStore;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNxbEV2ZW50RmVlZC5qcyJdLCJuYW1lcyI6WyJfYXN5bmMiLCJyZXF1aXJlIiwiX2Jvb2tzaGVsZiIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJwb2xsaW5nSW50ZXJ2YWwiLCJldmVudEJhdGNoU2l6ZSIsImZyb21TdG9yZWRFdmVudCIsImV2ZW50IiwiX29iamVjdFNwcmVhZCIsImFnZ3JlZ2F0ZSIsImFnZ3JlZ2F0ZUlkIiwidGltZXN0YW1wIiwidHlwZSIsInNlcXVlbmNlTnVtYmVyIiwiYWN0b3IiLCJwb3NpdGlvbiIsIkpTT04iLCJwYXJzZSIsImJvZHkiLCJFdmVudFN0b3JlIiwiX3JlZiIsIl90aGlzIiwidGhpcyIsImRiIiwicHJvamVjdGlvblN0YXRlIiwic3RvcmVzIiwiX2NsYXNzQ2FsbENoZWNrIiwiX2RlZmluZVByb3BlcnR5IiwiX2FzeW5jVG9HZW5lcmF0b3IiLCJyZWdlbmVyYXRvclJ1bnRpbWUiLCJtYXJrIiwiX2NhbGxlZTIiLCJib29rbWFyayIsIl9yZWYzIiwiZXZlbnRzIiwibmV3Qm9va21hcmsiLCJsYXN0Qm9va21hcmsiLCJ3cmFwIiwiX2NvbnRleHQyIiwicHJldiIsIm5leHQiLCJzZW50IiwiZ2V0TmV4dEV2ZW50cyIsImN1cnJlbnRTdGF0ZSIsInF1ZXVlIiwibGVuZ3RoIiwiY29uc29sZSIsImxvZyIsImZpbmlzaFJlc2V0IiwiZm9yRWFjaCIsInB1c2giLCJzZXRCb29rbWFyayIsInNldFRpbWVvdXQiLCJfY2FsbGVlIiwiX2NvbnRleHQiLCJjb25zdW1lRXZlbnRTdHJlYW0iLCJhYnJ1cHQiLCJzdG9wIiwiX3JlZjUiLCJfY2FsbGVlMyIsImwiLCJsYXN0RXZlbnQiLCJsYXN0UmVjb3JkIiwiX2NvbnRleHQzIiwiRXZlbnQiLCJ3aGVyZSIsInF1ZXJ5IiwicWIiLCJvcmRlckJ5IiwiZmV0Y2hQYWdlIiwicGFnZVNpemUiLCJpZCIsInRvSlNPTiIsImUiLCJ0MCIsImNvZGUiLCJfeCIsImFwcGx5IiwiYXJndW1lbnRzIiwiX3JlZjYiLCJfY2FsbGVlNCIsImtleSIsIl9jb250ZXh0NCIsInJlc2V0Iiwic2V0U3RhdGUiLCJfeDIiLCJzdWJzY3JpcHRpb25zIiwiX3JlZjciLCJfY2FsbGVlNiIsImNhbGxiYWNrIiwiX2NvbnRleHQ2IiwiY29uY2F0IiwiYWxsIiwibWFwIiwiX3JlZjgiLCJfY2FsbGVlNSIsInMiLCJfY29udGV4dDUiLCJub3RlIiwiX3g1IiwiX3gzIiwiX3g0Iiwia25leCIsInBsdWdpbiIsIk1vZGVsIiwiZXh0ZW5kIiwidGFibGVOYW1lIiwiUHJvbWlzZSIsIl9yZWY5IiwiX2NhbGxlZTciLCJwIiwiX2NvbnRleHQ3Iiwic3dhcCIsIl94NiIsInByb2plY3Rpb24iLCJzdGF0ZSJdLCJtYXBwaW5ncyI6IjJGQUFBLElBQUFBLE9BQUFDLFFBQUEsU0FDQUMsV0FBQUMsdUJBQUFGLFFBQUEsb2pEQUVBLElBQU1HLGdCQUFrQixJQUNsQkMsZUFBaUIsR0FFdkIsU0FBU0MsZ0JBQWdCQyxHQU56QixPQUFBQyxjQUFBLENBUUlDLFVBQVdGLEVBQU1FLFVBUHJCQyxZQUFBSCxFQUFBRyxZQVNJQyxVQUFXSixFQUFNSSxVQUNqQkMsS0FBTUwsRUFBTUssS0FDWkMsZUFBZ0JOLEVBQU1NLGVBQ3RCQyxNQUFPUCxFQUFNTyxNQUNiQyxTQUFVQyxLQUFLQyxNQUFNVixFQUFNUSxXQUN4QkMsS0FBS0MsTUFBTVYsRUFBTVcsV0FJSEMsc0JBQ25CLFNBQUFBLEVBQUFDLEdBQTZDLElBQUFDLEVBQUFDLEtBQS9CQyxFQUErQkgsRUFBL0JHLEdBQUlDLEVBQTJCSixFQUEzQkksZ0JBQWlCQyxFQUFVTCxFQUFWSyxPQUFVQyxnQkFBQUosS0FBQUgsR0FBQVEsZ0JBQUFMLEtBQUEscUJBQUFNLGtCQUFBQyxtQkFBQUMsS0FtRHhCLFNBQUFDLElBQUEsSUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQSxPQUFBUCxtQkFBQVEsS0FBQSxTQUFBQyxHQUFBLE9BQUEsT0FBQUEsRUFBQUMsS0FBQUQsRUFBQUUs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N0I0QnBGLEtBQVZHLG9PQUFVa0YsUUFBQWYsSUFBQXRFLEtBQUFHLE9BQUFvRSxJQUFBLFdBQUEsSUFBQWUsRUFBQWhGLGtCQUFBQyxtQkFBQUMsS0FBQSxTQUFBK0UsRUFBQUMsR0FBQSxPQUFBakYsbUJBQUFRLEtBQUEsU0FBQTBFLEdBQUEsT0FBQSxPQUFBQSxFQUFBeEUsS0FBQXdFLEVBQUF2RSxNQUFBLEtBQUEsRUFBQSxHQUFBdUUsRUFBQXJDLEdBQUFvQyxFQUFBRSxLQUFBRCxFQUFBckMsR0FBQSxPQUFBcUMsRUFBQXZFLEtBQUEsRUFBQXNFLEVBQUFFLE9BQUFELEVBQUF2RSxLQUFBLEVBQUEsTUFBQSxLQUFBLEVBQUF1RSxFQUFBckMsR0FBQXFDLEVBQUF0RSxLQUFBLEtBQUEsRUFBQSxPQUFBc0UsRUFBQXZELE9BQUEsU0FBQXVELEVBQUFyQyxJQUFBLEtBQUEsRUFBQSxJQUFBLE1BQUEsT0FBQXFDLEVBQUF0RCxTQUFBb0QsTUFBQSxPQUFBLFNBQUFJLEdBQUEsT0FBQUwsRUFBQS9CLE1BQUF2RCxLQUFBd0QsWUFBQSxZQUFBeEQsS0FBQThELFNBQUEsc0lBQUE4QixHQW1EeEI1RixLQUFBZ0UsY0FBQXBDLEtBQUFnRSxzQ0FBQSxPQUFBNUYsS0FBQXFCLDhDQUFBd0UsR0FBQTdGLEtBQUFxQixhQUNFd0UiLCJmaWxlIjoic3FsRXZlbnRGZWVkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcXVldWUgfSBmcm9tICdhc3luYyc7XG5pbXBvcnQgYm9va3NoZWxmIGZyb20gJ2Jvb2tzaGVsZic7XG5cbmNvbnN0IHBvbGxpbmdJbnRlcnZhbCA9IDEwMDtcbmNvbnN0IGV2ZW50QmF0Y2hTaXplID0gMTA7XG5cbmZ1bmN0aW9uIGZyb21TdG9yZWRFdmVudChldmVudCkge1xuICByZXR1cm4ge1xuICAgIGFnZ3JlZ2F0ZTogZXZlbnQuYWdncmVnYXRlLFxuICAgIGFnZ3JlZ2F0ZUlkOiBldmVudC5hZ2dyZWdhdGVJZCxcbiAgICB0aW1lc3RhbXA6IGV2ZW50LnRpbWVzdGFtcCxcbiAgICB0eXBlOiBldmVudC50eXBlLFxuICAgIHNlcXVlbmNlTnVtYmVyOiBldmVudC5zZXF1ZW5jZU51bWJlcixcbiAgICBhY3RvcjogZXZlbnQuYWN0b3IsXG4gICAgcG9zaXRpb246IEpTT04ucGFyc2UoZXZlbnQucG9zaXRpb24pLFxuICAgIC4uLkpTT04ucGFyc2UoZXZlbnQuYm9keSlcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXZlbnRTdG9yZSB7XG4gIGNvbnN0cnVjdG9yKHsgZGIsIHByb2plY3Rpb25TdGF0ZSwgc3RvcmVzIH0pIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICB0aGlzLnByb2plY3Rpb25TdGF0ZSA9IHByb2plY3Rpb25TdGF0ZTtcbiAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9ICdzdGFydGluZyc7XG4gICAgdGhpcy5zdG9yZXMgPSBzdG9yZXM7XG5cblxuICAgIHRoaXMucXVldWUgPSBxdWV1ZShhc3luYyAoZXZlbnQsIGNhbGxiYWNrKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhgRXZlbnQ6ICR7ZXZlbnQuYWdncmVnYXRlSWR9ICR7ZXZlbnQuYWdncmVnYXRlfS4ke2V2ZW50LnR5cGV9YCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnN1YnNjcmlwdGlvbnMubWFwKGFzeW5jIHMgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCBzKGV2ZW50KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgZ2xvYmFsLmxvZyA/IGdsb2JhbC5sb2cubm90ZSh7XG4gICAgICAgICAgICBlcnJvcjogZXJyLFxuICAgICAgICAgICAgYWdncmVnYXRlSWQ6IGV2ZW50LmFnZ3JlZ2F0ZUlkLFxuICAgICAgICAgICAgYWdncmVnYXRlOiBldmVudC5hZ2dyZWdhdGUsXG4gICAgICAgICAgICB0eXBlOiBldmVudC50eXBlLFxuICAgICAgICAgICAgZXZlbnQ6IGV2ZW50XG4gICAgICAgICAgfSkgOiBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICB9XG4gICAgICB9KSk7XG4gICAgICByZXR1cm4gY2FsbGJhY2soKTtcbiAgICB9KTtcblxuICAgIHRoaXMuRXZlbnQgPSBib29rc2hlbGYoZGIua25leCgnZXZlbnRzdG9yZScpKVxuICAgICAgLnBsdWdpbigncGFnaW5hdGlvbicpXG4gICAgICAuTW9kZWwuZXh0ZW5kKHtcbiAgICAgICAgdGFibGVOYW1lOiAnZXZlbnRzJ1xuICAgICAgfSk7XG5cbiAgICB0aGlzLmNvbnN1bWVFdmVudFN0cmVhbSgpO1xuICB9XG5cbiAgYXN5bmMgZmluaXNoUmVzZXQoKSB7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5zdG9yZXMubWFwKGFzeW5jIHAgPT4gcC5zd2FwICYmIGF3YWl0IHAuc3dhcCgpKSk7XG4gICAgdGhpcy5zZXRTdGF0ZSgncnVubmluZycpO1xuICB9XG5cbiAgc3Vic2NyaWJlKHByb2plY3Rpb24pIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChwcm9qZWN0aW9uKTtcbiAgfVxuXG4gIGdldFN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZTtcbiAgfVxuICBzZXRTdGF0ZShzdGF0ZSkge1xuICAgIHRoaXMuY3VycmVudFN0YXRlID0gc3RhdGU7XG4gIH1cblxuICBjb25zdW1lRXZlbnRTdHJlYW0gPSBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGJvb2ttYXJrID0gYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUuYm9va21hcmsoKTtcbiAgICBsZXQgeyBldmVudHMsIGJvb2ttYXJrOiBuZXdCb29rbWFyaywgbGFzdEJvb2ttYXJrIH0gPSBhd2FpdCB0aGlzLmdldE5leHRFdmVudHMoYm9va21hcmspO1xuICAgIC8vIGlmIHdlIGRlbGV0ZSBhbiBldmVudCBhdCB0aGUgdG9wIGFuZCByZXN0YXJ0LCB3ZSBjYW4gZW5kIHVwIHdpdGggYSBuZXdCb29rbWFyayA+IGxhc3QgKHZlcnN1cyA9PT0pXG4gICAgaWYgKHRoaXMuY3VycmVudFN0YXRlID09PSAnc3RhcnRpbmcnICYmIG5ld0Jvb2ttYXJrID49IGxhc3RCb29rbWFyayAmJiB0aGlzLnF1ZXVlLmxlbmd0aCgpID09PSAwKSB7XG4gICAgICBjb25zb2xlLmxvZygnUHJvamVjdGlvbnMgaXMgbm93IGJ1aWx0IGFuZCBlbnRlcmluZyBcIlJ1bm5pbmdcIiBzdGF0ZScpO1xuICAgICAgdGhpcy5zZXRTdGF0ZSgncnVubmluZycpO1xuICAgIH1cbiAgICBlbHNlIGlmICh0aGlzLmN1cnJlbnRTdGF0ZSA9PT0gJ3Jlc2V0dGluZycgJiYgbmV3Qm9va21hcmsgPj0gbGFzdEJvb2ttYXJrICYmIHRoaXMucXVldWUubGVuZ3RoKCkgPT09IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKCd3ZSBhcmUgcHJvYiBkb25lIHJlc2V0dGluZycpO1xuICAgICAgYXdhaXQgdGhpcy5maW5pc2hSZXNldCgpO1xuICAgIH1cbiAgICBpZiAoZXZlbnRzLmxlbmd0aCkge1xuICAgICAgZXZlbnRzLmZvckVhY2goZXZlbnQgPT4ge1xuICAgICAgICB0aGlzLnF1ZXVlLnB1c2goZXZlbnQpO1xuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHRoaXMucHJvamVjdGlvblN0YXRlLnNldEJvb2ttYXJrKG5ld0Jvb2ttYXJrKTtcbiAgICB9XG4gICAgc2V0VGltZW91dChhc3luYyAoKSA9PiBhd2FpdCB0aGlzLmNvbnN1bWVFdmVudFN0cmVhbSgpLCBuZXdCb29rbWFyayA8IGxhc3RCb29rbWFyayA/IDAgOiBwb2xsaW5nSW50ZXJ2YWwpO1xuICB9XG5cbiAgZ2V0TmV4dEV2ZW50cyA9IGFzeW5jIGJvb2ttYXJrID0+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGV2ZW50cyA9IChhd2FpdCB0aGlzLkV2ZW50XG4gICAgICAgIC53aGVyZSgnaWQnLCAnPicsIGJvb2ttYXJrKVxuICAgICAgICAucXVlcnkocWIgPT4gcWIub3JkZXJCeSgnaWQnLCAnYXNjJykpXG4gICAgICAgIC5mZXRjaFBhZ2UoeyBwYWdlU2l6ZTogZXZlbnRCYXRjaFNpemUgfSlcbiAgICAgICkudG9KU09OKCk7XG5cbiAgICAgIGxldCBuZXdCb29rbWFyayA9IGJvb2ttYXJrO1xuICAgICAgaWYgKGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgICAgbGV0IHsgbGVuZ3RoOiBsLCBbbCAtIDFdOiBsYXN0RXZlbnQgfSA9IGV2ZW50cztcbiAgICAgICAgbmV3Qm9va21hcmsgPSBsYXN0RXZlbnQuaWQ7XG4gICAgICB9XG5cbiAgICAgIGxldCBsYXN0UmVjb3JkID0gKGF3YWl0IHRoaXMuRXZlbnQucXVlcnkocWIgPT4gcWIub3JkZXJCeSgnaWQnLCAnZGVzYycpKS5mZXRjaFBhZ2UoeyBwYWdlU2l6ZTogMSB9KSkudG9KU09OKClbMF07XG4gICAgICBsZXQgbGFzdEJvb2ttYXJrID0gbGFzdFJlY29yZCAmJiBsYXN0UmVjb3JkLmlkO1xuXG4gICAgICByZXR1cm4geyBldmVudHM6IGV2ZW50cy5tYXAoZSA9PiBmcm9tU3RvcmVkRXZlbnQoZSkpLCBib29rbWFyazogbmV3Qm9va21hcmssIGxhc3RCb29rbWFyayB9O1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUuY29kZSAhPT0gJ0VSX0JBRF9EQl9FUlJPUicpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIGxvYWRpbmcgZXZlbnRzJywgZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4geyBldmVudHM6IFtdLCBib29rbWFyazogYm9va21hcmsgfTtcbiAgICB9XG4gIH1cblxuICByZXNldCA9IGFzeW5jIGtleSA9PiB7XG4gICAgYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUucmVzZXQoa2V5KTtcbiAgICB0aGlzLnNldFN0YXRlKCdyZXNldHRpbmcnKTtcbiAgfVxufVxuIl19
