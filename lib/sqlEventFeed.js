"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){function o(e,t){try{var r=i[e](t),o=r.value}catch(e){return void a(e)}r.done?n(o):Promise.resolve(o).then(u,s)}function u(e){o("next",e)}function s(e){o("throw",e)}var i=e.apply(t,r);u()})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _extends(){return _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_extends.apply(this,arguments)}function fromStoredEvent(e){return _extends({aggregate:e.aggregate,aggregateId:e.aggregateId,timestamp:e.timestamp,type:e.type,sequenceNumber:e.sequenceNumber,actor:e.actor,position:JSON.parse(e.position)},JSON.parse(e.body))}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _async=require("async"),_bookshelf=_interopRequireDefault(require("bookshelf")),pollingInterval=100,eventBatchSize=10,EventStore=function(){function e(t){var r=this,n=t.db,a=t.projectionState;_classCallCheck(this,e),Object.defineProperty(this,"consumeEventStream",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,a,o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.projectionState.bookmark();case 2:return t=e.sent,e.next=5,r.getNextEvents(t);case 5:if(n=e.sent,a=n.events,o=n.bookmark,u=n.lastBookmark,!a.length){e.next=13;break}return a.forEach(function(e){r.queue.push(e)}),e.next=13,r.projectionState.setBookmark(o);case 13:setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.consumeEventStream();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)})),o<u?0:pollingInterval);case 14:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}),Object.defineProperty(this,"getNextEvents",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,a,o,u,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.Event.where("id",">",t).query(function(e){return e.orderBy("id","asc")}).fetchPage({pageSize:eventBatchSize});case 3:return n=e.sent.toJSON(),a=t,n.length&&(o=n.length,u=n[o-1],a=u.id),e.next=8,r.Event.query(function(e){return e.orderBy("id","desc")}).fetchPage({pageSize:1});case 8:return s=e.sent.toJSON()[0],i=s&&s.id,e.abrupt("return",{events:n.map(function(e){return fromStoredEvent(e)}),bookmark:a,lastBookmark:i});case 13:return e.prev=13,e.t0=e.catch(0),"ER_BAD_DB_ERROR"!==e.t0.code&&console.log("Error loading events",e.t0),e.abrupt("return",{events:[],bookmark:t});case 17:case"end":return e.stop()}},e,this,[[0,13]])}));return function(t){return e.apply(this,arguments)}}()}),Object.defineProperty(this,"reset",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.projectionState.reset();case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}),this.subscriptions=[],this.projectionState=a,this.queue=(0,_async.queue)(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Event: ".concat(t.aggregate||""," ").concat(t.type)),e.next=3,Promise.all(r.subscriptions.map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r(t);case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),console.log(e.t0);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}()));case 3:return e.abrupt("return",n());case 4:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()),this.Event=(0,_bookshelf.default)(n.knex("eventstore")).plugin("pagination").Model.extend({tableName:"events"}),this.consumeEventStream()}return _createClass(e,[{key:"subscribe",value:function(e){this.subscriptions.push(e)}}]),e}();exports.default=EventStore;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNxbEV2ZW50RmVlZC5qcyJdLCJuYW1lcyI6WyJmcm9tU3RvcmVkRXZlbnQiLCJldmVudCIsIl9leHRlbmRzIiwiYWdncmVnYXRlIiwiYWdncmVnYXRlSWQiLCJ0aW1lc3RhbXAiLCJ0eXBlIiwic2VxdWVuY2VOdW1iZXIiLCJhY3RvciIsInBvc2l0aW9uIiwiSlNPTiIsInBhcnNlIiwiYm9keSIsIl9hc3luYyIsInJlcXVpcmUiLCJfYm9va3NoZWxmIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInBvbGxpbmdJbnRlcnZhbCIsImV2ZW50QmF0Y2hTaXplIiwiRXZlbnRTdG9yZSIsIl9yZWYiLCJfdGhpcyIsInRoaXMiLCJkYiIsInByb2plY3Rpb25TdGF0ZSIsIl9jbGFzc0NhbGxDaGVjayIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiY29uZmlndXJhYmxlIiwiZW51bWVyYWJsZSIsIndyaXRhYmxlIiwidmFsdWUiLCJfdmFsdWUiLCJfYXN5bmNUb0dlbmVyYXRvciIsInJlZ2VuZXJhdG9yUnVudGltZSIsIm1hcmsiLCJfY2FsbGVlMiIsImJvb2ttYXJrIiwiX3JlZjIiLCJldmVudHMiLCJuZXdCb29rbWFyayIsImxhc3RCb29rbWFyayIsIndyYXAiLCJfY29udGV4dDIiLCJwcmV2IiwibmV4dCIsInNlbnQiLCJnZXROZXh0RXZlbnRzIiwicXVldWUiLCJwdXNoIiwic2V0Qm9va21hcmsiLCJzZXRUaW1lb3V0Iiwic3RvcCIsImFwcGx5IiwiYXJndW1lbnRzIiwiX3ZhbHVlMiIsIl9jYWxsZWUzIiwibCIsImxhc3RFdmVudCIsImxhc3RSZWNvcmQiLCJfY29udGV4dDMiLCJFdmVudCIsIndoZXJlIiwicXVlcnkiLCJmZXRjaFBhZ2UiLCJ0b0pTT04iLCJsZW5ndGgiLCJxYiIsIm9yZGVyQnkiLCJwYWdlU2l6ZSIsImFicnVwdCIsImUiLCJ0MCIsImNvZGUiLCJjb25zb2xlIiwiX3giLCJfdmFsdWUzIiwiX2NhbGxlZTQiLCJfY29udGV4dDQiLCJzdWJzY3JpcHRpb25zIiwiX3JlZjQiLCJfY2FsbGVlNiIsImNhbGxiYWNrIiwiX2NvbnRleHQ2IiwibG9nIiwiY29uY2F0IiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsIl9yZWY1IiwiX2NhbGxlZTUiLCJzIiwiX2NvbnRleHQ1IiwiX3g0IiwiX3gyIiwiX3gzIiwiZGVmYXVsdCIsImtuZXgiLCJwbHVnaW4iLCJNb2RlbCIsImV4dGVuZCIsInRhYmxlTmFtZSIsImNvbnN1bWVFdmVudFN0cmVhbSIsInByb2plY3Rpb24iXSwibWFwcGluZ3MiOiJzK0JBTUEsUUFBU0EsaUJBQWdCQyxHQUN2QixNQUFBQyxXQUNFQyxVQUFXRixFQUFNRSxVQUNqQkMsWUFBYUgsRUFBTUcsWUFDbkJDLFVBQVdKLEVBQU1JLFVBQ2pCQyxLQUFNTCxFQUFNSyxLQUNaQyxlQUFnQk4sRUFBTU0sZUFDdEJDLE1BQU9QLEVBQU1PLE1BQ2JDLFNBQVVDLEtBQUtDLE1BQU1WLEVBQU1RLFdBQ25CRSxLQUFMQSxNQUFXVixFQVJoQlcsb0ZBUEYsSUFBQUMsUUFBQUMsUUFBQSxTQUNBQyxXQUFBQyx1QkFBQUYsUUFBQSxjQUVNRyxnQkFBa0IsSUFDbEJDLGVBQU4sR0FlcUJDLHNCQUNuQixRQUFBQSxHQUFBQyxHQUFxQyxHQUFBQyxHQUFBQyxLQUFyQ0MsRUFBcUNILEVBQXJDRyxHQUFBQyxFQUFxQ0osRUFBckNJLGVBQXFDQyxpQkFBQUgsS0FBQUgsR0FBQU8sT0FBQUMsZUFBQUwsS0FBQSxzQkFBQU0sY0FBQSxFQUFBQyxZQUFBLEVBQUFDLFVBQUEsRUFBQUMsTUFBQSxXQUFBLEdBQUFDLEdBQUFDLGtCQUFBQyxtQkFBQUMsS0E4QmhCLFFBQUFDLEtBQUEsR0FBQUMsR0FBQUMsRUFBQUMsRUFBQUMsRUFBQUMsQ0FBQSxPQUFBUCxvQkFBQVEsS0FBQSxTQUFBQyxHQUFBLE9BQUEsT0FBQUEsRUFBQUMsS0FBQUQsRUFBQUUsTUFBQSxJQUFBLEdBQUEsTUFBQUYsR0FBQUUsS0FBQSxFQUNFeEIsRUFBS0csZ0JBQWdCYSxVQUR2QixLQUFB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QUFBZ0QsRUFBQXBCLEdBQUFvQixFQUFBLE1BQUEsR0FLckNsQixRQUFRVSxJQUFSUSxFQUFBcEIsR0FMcUMsS0FBQSxHQUFBLElBQUEsTUFBQSxNQUFBb0IsR0FBQXhDLFNBQUFzQyxFQUFBcEUsT0FBQSxFQUFBLE9BQXZCLE9BQUEsVUFBQXVFLEdBQUEsTUFBQUosR0FBQXBDLE1BQUEvQixLQUFBZ0MsZ0JBRkQsS0FBQSxHQUFBLE1BQUE2QixHQUFBYixPQUFBLFNBVVZZLElBVlUsS0FBQSxHQUFBLElBQUEsTUFBQSxNQUFBQyxHQUFBL0IsU0FBQTZCLEVBQUEzRCxRQUFOLE9BQUEsVUFBQXdFLEVBQUFDLEdBQUEsTUFBQWYsR0FBQTNCLE1BQUEvQixLQUFBZ0MsZ0JBYWJoQyxLQUFLdUMsT0FBUSxFQUFBOUMsV0FBQWlGLFNBQVV6RSxFQUFHMEUsS0FBSyxlQUM1QkMsT0FBTyxjQUNQQyxNQUFNQyxRQUNMQyxVQUFXLFdBR2YvRSxLQUFLZ0YsNEVBR0dDLEdBQ1JqRixLQUFLeUQsY0FBYzlCLEtBQUtzRCIsImZpbGUiOiJzcWxFdmVudEZlZWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBxdWV1ZSB9IGZyb20gJ2FzeW5jJztcbmltcG9ydCBib29rc2hlbGYgZnJvbSAnYm9va3NoZWxmJztcblxuY29uc3QgcG9sbGluZ0ludGVydmFsID0gMTAwO1xuY29uc3QgZXZlbnRCYXRjaFNpemUgPSAxMDtcblxuZnVuY3Rpb24gZnJvbVN0b3JlZEV2ZW50KGV2ZW50KSB7XG4gIHJldHVybiB7XG4gICAgYWdncmVnYXRlOiBldmVudC5hZ2dyZWdhdGUsXG4gICAgYWdncmVnYXRlSWQ6IGV2ZW50LmFnZ3JlZ2F0ZUlkLFxuICAgIHRpbWVzdGFtcDogZXZlbnQudGltZXN0YW1wLFxuICAgIHR5cGU6IGV2ZW50LnR5cGUsXG4gICAgc2VxdWVuY2VOdW1iZXI6IGV2ZW50LnNlcXVlbmNlTnVtYmVyLFxuICAgIGFjdG9yOiBldmVudC5hY3RvcixcbiAgICBwb3NpdGlvbjogSlNPTi5wYXJzZShldmVudC5wb3NpdGlvbiksXG4gICAgLi4uSlNPTi5wYXJzZShldmVudC5ib2R5KVxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFdmVudFN0b3JlIHtcbiAgY29uc3RydWN0b3IoeyBkYiwgcHJvamVjdGlvblN0YXRlIH0pIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICB0aGlzLnByb2plY3Rpb25TdGF0ZSA9IHByb2plY3Rpb25TdGF0ZTtcblxuICAgIHRoaXMucXVldWUgPSBxdWV1ZShhc3luYyAoZXZlbnQsIGNhbGxiYWNrKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhgRXZlbnQ6ICR7ZXZlbnQuYWdncmVnYXRlIHx8ICcnfSAke2V2ZW50LnR5cGV9YCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnN1YnNjcmlwdGlvbnMubWFwKGFzeW5jIHMgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCBzKGV2ZW50KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSkpO1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLkV2ZW50ID0gYm9va3NoZWxmKGRiLmtuZXgoJ2V2ZW50c3RvcmUnKSlcbiAgICAgIC5wbHVnaW4oJ3BhZ2luYXRpb24nKVxuICAgICAgLk1vZGVsLmV4dGVuZCh7XG4gICAgICAgIHRhYmxlTmFtZTogJ2V2ZW50cydcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5jb25zdW1lRXZlbnRTdHJlYW0oKTtcbiAgfVxuXG4gIHN1YnNjcmliZShwcm9qZWN0aW9uKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2gocHJvamVjdGlvbik7XG4gIH1cblxuICBjb25zdW1lRXZlbnRTdHJlYW0gPSBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGJvb2ttYXJrID0gYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUuYm9va21hcmsoKTtcbiAgICBsZXQgeyBldmVudHMsIGJvb2ttYXJrOiBuZXdCb29rbWFyaywgbGFzdEJvb2ttYXJrIH0gPSBhd2FpdCB0aGlzLmdldE5leHRFdmVudHMoYm9va21hcmspO1xuXG4gICAgaWYgKGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgIGV2ZW50cy5mb3JFYWNoKGV2ZW50ID0+IHtcbiAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKGV2ZW50KTtcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCB0aGlzLnByb2plY3Rpb25TdGF0ZS5zZXRCb29rbWFyayhuZXdCb29rbWFyayk7XG4gICAgfVxuICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gYXdhaXQgdGhpcy5jb25zdW1lRXZlbnRTdHJlYW0oKSwgbmV3Qm9va21hcmsgPCBsYXN0Qm9va21hcmsgPyAwIDogcG9sbGluZ0ludGVydmFsKTtcbiAgfVxuXG4gIGdldE5leHRFdmVudHMgPSBhc3luYyBib29rbWFyayA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBldmVudHMgPSAoYXdhaXQgdGhpcy5FdmVudFxuICAgICAgICAud2hlcmUoJ2lkJywgJz4nLCBib29rbWFyaylcbiAgICAgICAgLnF1ZXJ5KHFiID0+IHFiLm9yZGVyQnkoJ2lkJywgJ2FzYycpKVxuICAgICAgICAuZmV0Y2hQYWdlKHsgcGFnZVNpemU6IGV2ZW50QmF0Y2hTaXplIH0pXG4gICAgICApLnRvSlNPTigpO1xuXG4gICAgICBsZXQgbmV3Qm9va21hcmsgPSBib29rbWFyaztcbiAgICAgIGlmIChldmVudHMubGVuZ3RoKSB7XG4gICAgICAgIGxldCB7IGxlbmd0aDogbCwgW2wgLSAxXTogbGFzdEV2ZW50IH0gPSBldmVudHM7XG4gICAgICAgIG5ld0Jvb2ttYXJrID0gbGFzdEV2ZW50LmlkO1xuICAgICAgfVxuXG4gICAgICBsZXQgbGFzdFJlY29yZCA9IChhd2FpdCB0aGlzLkV2ZW50LnF1ZXJ5KHFiID0+IHFiLm9yZGVyQnkoJ2lkJywgJ2Rlc2MnKSkuZmV0Y2hQYWdlKHsgcGFnZVNpemU6IDEgfSkpLnRvSlNPTigpIFswXTtcbiAgICAgIGxldCBsYXN0Qm9va21hcmsgPSBsYXN0UmVjb3JkICYmIGxhc3RSZWNvcmQuaWQ7XG5cbiAgICAgIHJldHVybiB7IGV2ZW50czogZXZlbnRzLm1hcChlID0+IGZyb21TdG9yZWRFdmVudChlKSksIGJvb2ttYXJrOiBuZXdCb29rbWFyaywgbGFzdEJvb2ttYXJrIH07XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5jb2RlICE9PSAnRVJfQkFEX0RCX0VSUk9SJykge1xuICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgbG9hZGluZyBldmVudHMnLCBlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7IGV2ZW50czogW10sIGJvb2ttYXJrOiBib29rbWFyayB9O1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0ID0gYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRoaXMucHJvamVjdGlvblN0YXRlLnJlc2V0KCk7XG4gIH1cbn1cbiJdfQ==
