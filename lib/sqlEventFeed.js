"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _async=require("async"),_bookshelf=_interopRequireDefault(require("bookshelf"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,t,r,n,o,a,u){try{var s=e[a](u),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function _asyncToGenerator(s){return function(){var e=this,u=arguments;return new Promise(function(t,r){var n=s.apply(e,u);function o(e){asyncGeneratorStep(n,t,r,o,a,"next",e)}function a(e){asyncGeneratorStep(n,t,r,o,a,"throw",e)}o(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(e){_defineProperty(t,e,r[e])})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var pollingInterval=100,eventBatchSize=10;function fromStoredEvent(e){return _objectSpread({aggregate:e.aggregate,aggregateId:e.aggregateId,timestamp:e.timestamp,type:e.type,sequenceNumber:e.sequenceNumber,actor:e.actor,position:JSON.parse(e.position)},JSON.parse(e.body))}var EventStore=function(){function n(e){var c=this,t=e.db,r=e.projectionState;_classCallCheck(this,n),_defineProperty(this,"consumeEventStream",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.projectionState.bookmark();case 2:return t=e.sent,e.next=5,c.getNextEvents(t);case 5:if(r=e.sent,n=r.events,o=r.bookmark,a=r.lastBookmark,n.length)return n.forEach(function(e){c.queue.push(e)}),e.next=13,c.projectionState.setBookmark(o);e.next=13;break;case 13:setTimeout(_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.consumeEventStream();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)})),o<a?0:pollingInterval);case 14:case"end":return e.stop()}},e,this)}))),_defineProperty(this,"getNextEvents",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,a,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.Event.where("id",">",t).query(function(e){return e.orderBy("id","asc")}).fetchPage({pageSize:eventBatchSize});case 3:return r=e.sent.toJSON(),n=t,r.length&&(o=r.length,a=r[o-1],n=a.id),e.next=8,c.Event.query(function(e){return e.orderBy("id","desc")}).fetchPage({pageSize:1});case 8:return u=e.sent.toJSON()[0],s=u&&u.id,e.abrupt("return",{events:r.map(function(e){return fromStoredEvent(e)}),bookmark:n,lastBookmark:s});case 13:return e.prev=13,e.t0=e.catch(0),"ER_BAD_DB_ERROR"!==e.t0.code&&console.log("Error loading events",e.t0),e.abrupt("return",{events:[],bookmark:t});case 17:case"end":return e.stop()}},e,this,[[0,13]])}));return function(e){return t.apply(this,arguments)}}()),_defineProperty(this,"reset",_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.projectionState.reset();case 2:case"end":return e.stop()}},e,this)}))),this.subscriptions=[],this.projectionState=r,this.queue=(0,_async.queue)(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Event: ".concat(r.aggregateId," ").concat(r.aggregate,".").concat(r.type)),e.next=3,Promise.all(c.subscriptions.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t(r);case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),global.log?global.log.note({error:e.t0,aggregateId:r.aggregateId,aggregate:r.aggregate,type:r.type,event:r}):console.log(e.t0);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(e){return t.apply(this,arguments)}}()));case 3:return e.abrupt("return",t());case 4:case"end":return e.stop()}},e,this)}));return function(e,t){return r.apply(this,arguments)}}()),this.Event=(0,_bookshelf.default)(t.knex("eventstore")).plugin("pagination").Model.extend({tableName:"events"}),this.consumeEventStream()}return _createClass(n,[{key:"subscribe",value:function(e){this.subscriptions.push(e)}}]),n}();exports.default=EventStore;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNxbEV2ZW50RmVlZC5qcyJdLCJuYW1lcyI6WyJfYXN5bmMiLCJyZXF1aXJlIiwiX2Jvb2tzaGVsZiIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJwb2xsaW5nSW50ZXJ2YWwiLCJldmVudEJhdGNoU2l6ZSIsImZyb21TdG9yZWRFdmVudCIsImV2ZW50IiwiX29iamVjdFNwcmVhZCIsImFnZ3JlZ2F0ZSIsImFnZ3JlZ2F0ZUlkIiwidGltZXN0YW1wIiwidHlwZSIsInNlcXVlbmNlTnVtYmVyIiwiYWN0b3IiLCJwb3NpdGlvbiIsIkpTT04iLCJwYXJzZSIsImJvZHkiLCJFdmVudFN0b3JlIiwiX3JlZiIsIl90aGlzIiwidGhpcyIsImRiIiwicHJvamVjdGlvblN0YXRlIiwiX2NsYXNzQ2FsbENoZWNrIiwiX2RlZmluZVByb3BlcnR5IiwiX2FzeW5jVG9HZW5lcmF0b3IiLCJyZWdlbmVyYXRvclJ1bnRpbWUiLCJtYXJrIiwiX2NhbGxlZTIiLCJib29rbWFyayIsIl9yZWYzIiwiZXZlbnRzIiwibmV3Qm9va21hcmsiLCJsYXN0Qm9va21hcmsiLCJ3cmFwIiwiX2NvbnRleHQyIiwicHJldiIsIm5leHQiLCJzZW50IiwiZ2V0TmV4dEV2ZW50cyIsImxlbmd0aCIsImZvckVhY2giLCJxdWV1ZSIsInB1c2giLCJzZXRUaW1lb3V0IiwiX2NhbGxlZSIsIl9jb250ZXh0IiwiY29uc3VtZUV2ZW50U3RyZWFtIiwiYWJydXB0Iiwic3RvcCIsIl9yZWY1IiwiX2NhbGxlZTMiLCJsIiwibGFzdEV2ZW50IiwibGFzdFJlY29yZCIsIl9jb250ZXh0MyIsIkV2ZW50Iiwid2hlcmUiLCJxYiIsIm9yZGVyQnkiLCJpZCIsInF1ZXJ5IiwiZmV0Y2hQYWdlIiwicGFnZVNpemUiLCJ0b0pTT04iLCJ0MCIsImNvbnNvbGUiLCJsb2ciLCJfeCIsImFwcGx5IiwiYXJndW1lbnRzIiwiX2NhbGxlZTQiLCJfY29udGV4dDQiLCJyZXNldCIsInN1YnNjcmlwdGlvbnMiLCJfcmVmNyIsIl9jYWxsZWU2IiwiY2FsbGJhY2siLCJfY29udGV4dDYiLCJjb25jYXQiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiX3JlZjgiLCJfY2FsbGVlNSIsInMiLCJfY29udGV4dDUiLCJnbG9iYWwiLCJub3RlIiwiX3g0IiwiX3gyIiwiX3gzIiwiZGVmYXVsdCIsImtuZXgiLCJwbHVnaW4iLCJNb2RlbCIsImV4dGVuZCIsInRhYmxlTmFtZSIsInByb2plY3Rpb24iXSwibWFwcGluZ3MiOiIyRkFBQSxJQUFBQSxPQUFBQyxRQUFBLFNBQ0FDLFdBQUFDLHVCQUFBRixRQUFBLDZ6Q0FFQSxJQUFNRyxnQkFBa0IsSUFDbEJDLGVBQWlCLEdBRXZCLFNBQVNDLGdCQUFnQkMsR0FOekIsT0FBQUMsY0FBQSxDQVFJQyxVQUFXRixFQUFNRSxVQVByQkMsWUFBQUgsRUFBQUcsWUFTSUMsVUFBV0osRUFBTUksVUFDakJDLEtBQU1MLEVBQU1LLEtBQ1pDLGVBQWdCTixFQUFNTSxlQUN0QkMsTUFBT1AsRUFBTU8sTUFDYkMsU0FBVUMsS0FBS0MsTUFBTVYsRUFBTVEsV0FDeEJDLEtBQUtDLE1BQU1WLEVBQU1XLFdBSUhDLHNCQUNuQixTQUFBQSxFQUFBQyxHQUFxQyxJQUFBQyxFQUFBQyxLQUF2QkMsRUFBdUJILEVBQXZCRyxHQUFJQyxFQUFtQkosRUFBbkJJLGdCQUFtQkMsZ0JBQUFILEtBQUFILEdBQUFPLGdCQUFBSixLQUFBLHFCQUFBSyxrQkFBQUMsbUJBQUFDLEtBQUEsU0FBQUMsSUFBQSxJQUFBQyxFQUFBQyxFQUFBQyxFQUFBQyxFQUFBQyxFQUFBLE9BQUFQLG1CQUFBUSxLQUFBLFNBQUFDLEdBQUEsT0FBQSxPQUFBQSxFQUFBQyxLQUFBRCxFQUFBRSxNQUFBLEtBQUEsRUFBQSxPQUFBRixFQUFBRSxLQUFBLEVBQUFsQixFQW9DaEJHLGdCQUFBTyxXQXBDZ0IsS0FBQSxFQUFBLE9BQUFBLEVBQUFNLEVBQUFHLEtBQUFILEVBQUFFLEtBQUEsRUFvQ2hCbEIsRUFBQW9CLGNBQUFWLEdBcENnQixLQUFBLEVBQUEsR0FBQUMs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ckMsU0FBQW1DLEVBQUFoRSxLQUFBLENBQUEsQ0FBQSxFQUFBLFFBQXZCLE9BQUEsU0FBQXFFLEdBQUEsT0FBQU4sRUFBQWQsTUFBQWpELEtBQUFrRCxZQUFBLEtBRkQsS0FBQSxFQUFBLE9BQUFRLEVBQUE5QixPQUFBLFNBUHRCNkIsS0FPc0IsS0FBQSxFQUFBLElBQUEsTUFBQSxPQUFBQyxFQUFBN0IsU0FBQTJCLEVBQUF4RCxTQUFOLE9BQUEsU0FBQXNFLEVBQUFDLEdBQUEsT0FBQWhCLEVBQUFOLE1BQUFqRCxLQUFBa0QsWUFBQSxJQW1CYmxELEtBQUtvQyxPQUFRLEVBQUF4RCxXQUFBNEYsU0FBVXZFLEVBQUd3RSxLQUFLLGVBQzVCQyxPQUFPLGNBeEJaQyxNQUFBQyxPQUFBLENBQXFDQyxVQUFBLFdBQUE3RSxLQUFuQkUsNEVBZ0NSNEUsR0FoQzJCOUUsS0FBQXNELGNBQUEvQixLQUFBdUQiLCJmaWxlIjoic3FsRXZlbnRGZWVkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcXVldWUgfSBmcm9tICdhc3luYyc7XG5pbXBvcnQgYm9va3NoZWxmIGZyb20gJ2Jvb2tzaGVsZic7XG5cbmNvbnN0IHBvbGxpbmdJbnRlcnZhbCA9IDEwMDtcbmNvbnN0IGV2ZW50QmF0Y2hTaXplID0gMTA7XG5cbmZ1bmN0aW9uIGZyb21TdG9yZWRFdmVudChldmVudCkge1xuICByZXR1cm4ge1xuICAgIGFnZ3JlZ2F0ZTogZXZlbnQuYWdncmVnYXRlLFxuICAgIGFnZ3JlZ2F0ZUlkOiBldmVudC5hZ2dyZWdhdGVJZCxcbiAgICB0aW1lc3RhbXA6IGV2ZW50LnRpbWVzdGFtcCxcbiAgICB0eXBlOiBldmVudC50eXBlLFxuICAgIHNlcXVlbmNlTnVtYmVyOiBldmVudC5zZXF1ZW5jZU51bWJlcixcbiAgICBhY3RvcjogZXZlbnQuYWN0b3IsXG4gICAgcG9zaXRpb246IEpTT04ucGFyc2UoZXZlbnQucG9zaXRpb24pLFxuICAgIC4uLkpTT04ucGFyc2UoZXZlbnQuYm9keSlcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXZlbnRTdG9yZSB7XG4gIGNvbnN0cnVjdG9yKHsgZGIsIHByb2plY3Rpb25TdGF0ZSB9KSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gW107XG4gICAgdGhpcy5wcm9qZWN0aW9uU3RhdGUgPSBwcm9qZWN0aW9uU3RhdGU7XG5cbiAgICB0aGlzLnF1ZXVlID0gcXVldWUoYXN5bmMgKGV2ZW50LCBjYWxsYmFjaykgPT4ge1xuICAgICAgY29uc29sZS5sb2coYEV2ZW50OiAke2V2ZW50LmFnZ3JlZ2F0ZUlkfSAke2V2ZW50LmFnZ3JlZ2F0ZX0uJHtldmVudC50eXBlfWApO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5zdWJzY3JpcHRpb25zLm1hcChhc3luYyBzID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgcyhldmVudCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgIGdsb2JhbC5sb2cgPyBnbG9iYWwubG9nLm5vdGUoe1xuICAgICAgICAgICAgZXJyb3I6IGVycixcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZUlkOiBldmVudC5hZ2dyZWdhdGVJZCxcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZTogZXZlbnQuYWdncmVnYXRlLFxuICAgICAgICAgICAgdHlwZTogZXZlbnQudHlwZSxcbiAgICAgICAgICAgIGV2ZW50OiBldmVudFxuICAgICAgICAgIH0pIDogY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSkpO1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLkV2ZW50ID0gYm9va3NoZWxmKGRiLmtuZXgoJ2V2ZW50c3RvcmUnKSlcbiAgICAgIC5wbHVnaW4oJ3BhZ2luYXRpb24nKVxuICAgICAgLk1vZGVsLmV4dGVuZCh7XG4gICAgICAgIHRhYmxlTmFtZTogJ2V2ZW50cydcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5jb25zdW1lRXZlbnRTdHJlYW0oKTtcbiAgfVxuXG4gIHN1YnNjcmliZShwcm9qZWN0aW9uKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2gocHJvamVjdGlvbik7XG4gIH1cblxuICBjb25zdW1lRXZlbnRTdHJlYW0gPSBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGJvb2ttYXJrID0gYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUuYm9va21hcmsoKTtcbiAgICBsZXQgeyBldmVudHMsIGJvb2ttYXJrOiBuZXdCb29rbWFyaywgbGFzdEJvb2ttYXJrIH0gPSBhd2FpdCB0aGlzLmdldE5leHRFdmVudHMoYm9va21hcmspO1xuXG4gICAgaWYgKGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgIGV2ZW50cy5mb3JFYWNoKGV2ZW50ID0+IHtcbiAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKGV2ZW50KTtcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCB0aGlzLnByb2plY3Rpb25TdGF0ZS5zZXRCb29rbWFyayhuZXdCb29rbWFyayk7XG4gICAgfVxuICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gYXdhaXQgdGhpcy5jb25zdW1lRXZlbnRTdHJlYW0oKSwgbmV3Qm9va21hcmsgPCBsYXN0Qm9va21hcmsgPyAwIDogcG9sbGluZ0ludGVydmFsKTtcbiAgfVxuXG4gIGdldE5leHRFdmVudHMgPSBhc3luYyBib29rbWFyayA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBldmVudHMgPSAoYXdhaXQgdGhpcy5FdmVudFxuICAgICAgICAud2hlcmUoJ2lkJywgJz4nLCBib29rbWFyaylcbiAgICAgICAgLnF1ZXJ5KHFiID0+IHFiLm9yZGVyQnkoJ2lkJywgJ2FzYycpKVxuICAgICAgICAuZmV0Y2hQYWdlKHsgcGFnZVNpemU6IGV2ZW50QmF0Y2hTaXplIH0pXG4gICAgICApLnRvSlNPTigpO1xuXG4gICAgICBsZXQgbmV3Qm9va21hcmsgPSBib29rbWFyaztcbiAgICAgIGlmIChldmVudHMubGVuZ3RoKSB7XG4gICAgICAgIGxldCB7IGxlbmd0aDogbCwgW2wgLSAxXTogbGFzdEV2ZW50IH0gPSBldmVudHM7XG4gICAgICAgIG5ld0Jvb2ttYXJrID0gbGFzdEV2ZW50LmlkO1xuICAgICAgfVxuXG4gICAgICBsZXQgbGFzdFJlY29yZCA9IChhd2FpdCB0aGlzLkV2ZW50LnF1ZXJ5KHFiID0+IHFiLm9yZGVyQnkoJ2lkJywgJ2Rlc2MnKSkuZmV0Y2hQYWdlKHsgcGFnZVNpemU6IDEgfSkpLnRvSlNPTigpWzBdO1xuICAgICAgbGV0IGxhc3RCb29rbWFyayA9IGxhc3RSZWNvcmQgJiYgbGFzdFJlY29yZC5pZDtcblxuICAgICAgcmV0dXJuIHsgZXZlbnRzOiBldmVudHMubWFwKGUgPT4gZnJvbVN0b3JlZEV2ZW50KGUpKSwgYm9va21hcms6IG5ld0Jvb2ttYXJrLCBsYXN0Qm9va21hcmsgfTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLmNvZGUgIT09ICdFUl9CQURfREJfRVJST1InKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBsb2FkaW5nIGV2ZW50cycsIGUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgZXZlbnRzOiBbXSwgYm9va21hcms6IGJvb2ttYXJrIH07XG4gICAgfVxuICB9XG5cbiAgcmVzZXQgPSBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdGhpcy5wcm9qZWN0aW9uU3RhdGUucmVzZXQoKTtcbiAgfVxufVxuIl19
